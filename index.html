<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minispill | 1980s Retro</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Grunnleggende kropp og bakgrunn for 1980s terminalf칮lelse */
        body {
            font-family: 'monospace', sans-serif; /* Retro terminal-font */
            background-color: #000000; /* Dyp svart bakgrunn */
            color: #00FFFF; /* Neon cyan/bl친 for all tekst */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1.5rem;
            box-sizing: border-box;
            /* Subtil retro-effekt (simulerer scanlines/st칮y) */
            background-image: linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 3px 3px;
        }

        /* Hovedcontainer for alle elementer (stablingskontekst) */
        .main-wrapper {
            width: 100%;
            max-width: 900px; /* Maks bredde for lesbarhet */
            display: flex;
            flex-direction: column;
            gap: 2rem; /* Mellomrom mellom boksene */
        }

        /* Felles stil for alle de store, rektangul칝re boksene */
        .retro-box {
            background-color: #000000; /* Svart bakgrunn for boksene */
            border: 2px solid #00FFFF; /* Neon cyan kant */
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5), inset 0 0 5px rgba(0, 255, 255, 0.3); /* Neon gl칮d */
            padding: 1.5rem;
            text-align: center;
        }

        /* Topp-boks: Tittel og menyknapper */
        .top-box {
            composes: retro-box; /* Arver fra retro-box */
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        h1 {
            font-size: 3rem; /* Stor og dominerende tittel */
            font-weight: bold;
            color: #00FFFF; /* Neon cyan */
            text-shadow: 0 0 8px rgba(0, 255, 255, 0.8), 0 0 15px rgba(0, 255, 255, 0.6); /* Kraftig neon gl칮d */
            margin-bottom: 2rem;
            letter-spacing: 0.1em; /* Mellomrom mellom bokstaver for retro-f칮lelse */
        }

        .game-menu-retro {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
        }

        /* Stil for menyknappene */
        .retro-button {
            background-color: transparent;
            border: 2px solid #00FFFF; /* Neon cyan kant */
            color: #00FFFF; /* Neon cyan tekst */
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3); /* Subtil gl칮d */
            border-radius: 0; /* Skarpe kanter */
        }

        .retro-button:hover {
            background-color: #00FFFF; /* Fyll med farge ved hover */
            color: #000000; /* Svart tekst ved hover */
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8), 0 0 20px rgba(0, 255, 255, 0.6); /* Mer intens gl칮d */
        }
        .retro-button:active {
            background-color: #00BBBB; /* Litt m칮rkere cyan ved klikk */
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.8);
        }
        .retro-button:disabled {
            border-color: #4B5563;
            color: #6B7280;
            cursor: not-allowed;
            opacity: 0.6;
            background-color: transparent;
            box-shadow: none;
        }
        .retro-button:disabled:hover {
            background-color: transparent;
            color: #6B7280;
            box-shadow: none;
        }


        /* Midtre boks: Spillomr친de */
        .game-area-retro {
            composes: retro-box; /* Arver fra retro-box */
            min-height: 350px; /* Minimum h칮yde */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .game-area-retro p {
            color: #00FFFF;
            font-size: 1.5rem;
            letter-spacing: 0.03em;
        }

        /* Spillspesifikke stiler inni spillomr친det (justert til neon-tema) */
        #guessTheNumberGame, #questionGame, #snakeGame, #pongGame {
            background-color: #000000; /* Svart bakgrunn for spilldivs */
            border: none; /* Fjern intern ramme om n칮dvendig */
            box-shadow: none; /* Fjern intern skygge om n칮dvendig */
            padding: 0; /* Fjern padding om n칮dvendig for renere look */
            width: 100%; /* S칮rg for at den fyller game-area-retro */
            max-width: none;
        }

        #guessTheNumberGame h2, #questionGame h2, #snakeGame h2, #pongGame h2 {
            color: #00FFFF; /* Neon cyan */
            text-shadow: 0 0 8px rgba(0, 255, 255, 0.8);
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        #guessTheNumberGame input[type="number"],
        #questionGame input[type="text"],
        #userChatInput { /* Ogs친 for chat input */
            background-color: #000000;
            border: 1px solid #00FFFF;
            color: #00FFFF;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
            padding: 0.6rem 1rem;
            border-radius: 0;
            text-align: center;
            font-size: 1.125rem;
            letter-spacing: 0.03em;
        }
        #guessTheNumberGame input[type="number"]:focus,
        #questionGame input[type="text"]:focus,
        #userChatInput:focus {
            outline: none;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.8), inset 0 0 3px rgba(0, 255, 255, 0.5);
        }

        /* Knapper inne i spill- og chat-omr친dene */
        #guessTheNumberGame button,
        #questionGame button,
        #snakeGameControls button,
        #pongGameControls button,
        #userChatContainer button:not(#userChatSendButton) { /* Spesifikk for "T칮m Chat" */
            background-color: transparent;
            border: 2px solid #00FFFF;
            color: #00FFFF;
            padding: 0.6rem 1.2rem;
            font-weight: bold;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
            border-radius: 0;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            margin-top: 1rem; /* Mer avstand fra input */
        }

        #guessTheNumberGame button:hover,
        #questionGame button:hover,
        #snakeGameControls button:hover,
        #pongGameControls button:hover,
        #userChatContainer button:not(#userChatSendButton):hover {
            background-color: #00FFFF;
            color: #000000;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8), 0 0 20px rgba(0, 255, 255, 0.6);
        }
        #guessTheNumberGame button:active,
        #questionGame button:active,
        #snakeGameControls button:active,
        #pongGameControls button:active,
        #userChatContainer button:not(#userChatSendButton):active {
            background-color: #00BBBB;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.8);
        }

        /* Snake og Pong Canvas */
        #snakeCanvas, #pongCanvas {
            background-color: #0A0A0A; /* Nesten svart for spillomr친det */
            border: 2px solid #00FFFF;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.6), inset 0 0 5px rgba(0, 255, 255, 0.3);
            border-radius: 0;
            width: 100%; /* For responsive canvas */
            height: auto; /* Maintain aspect ratio */
            max-width: 400px; /* Maks bredde som i forrige versjon */
            aspect-ratio: 1 / 1; /* Behold kvadratisk for snake */
        }
        #pongCanvas {
            max-width: 500px; /* Maks bredde for pong */
            aspect-ratio: 5 / 3; /* Pong aspect ratio */
        }
        
        /* Justering av elementer i Snake/Pong for 친 passe temaet */
        /* Snake */
        #snakeCanvas + #snakeGameControls button { margin-top: 1.5rem; }
        #snakeScore { color: #00FFFF; text-shadow: 0 0 5px rgba(0, 255, 255, 0.5); }

        /* Pong */
        #pongCanvas + #pongGameControls button { margin-top: 1.5rem; }
        #pongScore { color: #00FFFF; text-shadow: 0 0 5px rgba(0, 255, 255, 0.5); }
        #pongMessage { color: #FFFF00; text-shadow: 0 0 5px rgba(255, 255, 0, 0.5); }
        .pong-controls-info { color: #00FFFF; font-size: 0.85rem; }


        /* Bunn-boks: Bruker Chat */
        .bottom-box {
            composes: retro-box; /* Arver fra retro-box */
        }

        #userChatOutput {
            background-color: #0A0A0A; /* M칮rkere bakgrunn for chat-output */
            border: 1px solid #00FFFF;
            color: #00FFFF;
            padding: 1rem;
            min-height: 150px; /* Mindre chat-vindu som i bildet */
            max-height: 250px; /* Liten, men scrollbar hvis mer innhold */
            overflow-y: auto;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            line-height: 1.4;
            border-radius: 0;
            box-shadow: inset 0 0 5px rgba(0, 255, 255, 0.3);
        }

        .chat-message {
            padding: 0.3rem 0.6rem;
            border-radius: 0; /* Skarpe kanter */
            max-width: 95%; /* Mindre marger */
            word-break: break-word; /* Sikrer at lange ord brytes */
        }

        .user-chat-message {
            background-color: rgba(0, 150, 255, 0.2); /* Semi-transparent bl친 */
            border-left: 3px solid #00FFFF; /* Marker venstre side */
            align-self: flex-start;
        }
        .current-user-chat-message {
            background-color: rgba(0, 255, 0, 0.1); /* Semi-transparent gr칮nn for egen melding */
            border-right: 3px solid #00FFFF; /* Marker h칮yre side */
            align-self: flex-end;
            text-align: right;
        }
        .chat-message span.font-bold {
            color: #00FFFF;
            text-shadow: 0 0 3px rgba(0, 255, 255, 0.5);
        }
        .chat-message span.text-xs {
            color: #9CA3AF; /* Gr친ere for tid */
        }

        #userChatInputContainer {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        #userChatSendButton {
            background-color: transparent;
            border: 2px solid #00FFFF;
            color: #00FFFF;
            padding: 0.75rem 1.25rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
            border-radius: 0;
            flex-shrink: 0; /* Hindrer krymping */
        }
        #userChatSendButton:hover {
            background-color: #00FFFF;
            color: #000000;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8), 0 0 20px rgba(0, 255, 255, 0.6);
        }
        #userChatSendButton:active {
            background-color: #00BBBB;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.8);
        }

        #userChatLoadingIndicator {
            color: #00FFFF;
            font-style: italic;
            margin-top: 0.5rem;
            text-align: center;
        }

        #currentUserId {
            color: #FFFF00; /* Gul for ID for 친 skille den ut */
            text-shadow: 0 0 5px rgba(255, 255, 0, 0.5);
        }

        /* Skjul AI Chat i denne layouten for 친 matche bildet */
        #aiChatContainer {
            display: none !important;
        }

        footer {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.875rem;
            color: #9CA3AF; /* Gr친ere tekst for mindre viktig info */
        }

        /* Responsivitet for sm친 skjermer */
        @media (max-width: 640px) {
            body {
                padding: 0.5rem;
            }
            .main-wrapper {
                gap: 1rem;
                padding: 0.5rem;
            }
            .retro-box {
                padding: 1rem;
            }
            h1 {
                font-size: 2rem;
                margin-bottom: 1rem;
            }
            .game-menu-retro {
                gap: 1rem;
            }
            .retro-button {
                width: 100%;
                max-width: none;
                padding: 0.6rem 1rem;
            }
            .game-area-retro p {
                font-size: 1.2rem;
            }
            #userChatOutput {
                min-height: 100px;
            }
            #userChatInputContainer {
                flex-direction: column;
                gap: 0.5rem;
            }
            #userChatSendButton {
                width: 100%;
            }
            #guessTheNumberGame input[type="number"],
            #questionGame input[type="text"],
            #userChatInput {
                max-width: 100%;
            }
             #snakeCanvas, #pongCanvas {
                width: 100%; /* Ensure canvas scales down */
                height: auto; /* Maintain aspect ratio */
             }
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="top-box">
            <h1>MINISPILL 1980s</h1>
            <div class="game-menu-retro">
                <button class="retro-button" onclick="loadGame('guessTheNumber')">Gjett Tallet</button>
                <button class="retro-button" onclick="loadGame('pongGame')">Pong</button>
                <button class="retro-button" onclick="loadGame('snakeGame')">Snake</button>
            </div>
        </div>

        <main class="game-area-retro" id="gameArea">
            <!-- Spillinnholdet vil lastes inn her via JavaScript -->
            <p>Velg et spill for 친 starte!</p>
        </main>

        <!-- Bruker Chat er n친 den faste bunn-boksen -->
        <div id="userChatContainer" class="bottom-box">
            <h2 class="text-2xl font-bold text-center mb-4" style="color: #00FFFF; text-shadow: 0 0 8px rgba(0, 255, 255, 0.6);">BRUKER CHAT</h2>
            <div id="userChatOutput" class="flex-grow overflow-y-auto mb-4">
                <!-- Bruker chat messages will appear here -->
            </div>
            <p id="userChatLoadingIndicator" class="text-center italic text-gray-400 hidden">Sender melding...</p>
            <div id="userChatInputContainer" class="flex gap-2">
                <input type="text" id="userChatInput" placeholder="SKRIV MELDING..." class="flex-grow">
                <button id="userChatSendButton" onclick="sendMessageUserChat()">SEND</button>
            </div>
            <div class="flex flex-wrap justify-between items-center mt-4 text-sm text-gray-400">
                <span>DIN ID: <span id="currentUserId" class="font-mono text-white text-xs break-all">LASTER...</span></span>
                <button onclick="clearUserChat()" class="retro-button px-3 py-1 text-sm">T칒M CHAT</button>
            </div>
        </div>


        <footer>
            <p>&copy; 2025 MINISPILL ARCADE</p>
        </footer>
    </div>

    <!-- Firebase SDK - IKKE ENDRE URL -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globala variabler (definieras av Canvas-milj칬n)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase-initiering
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = 'anonymous'; // Standardverdi

        // Funktion f칬r att hantera anv칛ndarinloggning
        async function authenticateFirebase() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase autentiseringsfel:", error);
            }
        }

        // Lyssnare f칬r autentiseringstillst친nd
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                // Update the ID display only if the element exists
                const userIdDisplay = document.getElementById('currentUserId');
                if (userIdDisplay) {
                    userIdDisplay.textContent = currentUserId; // Show full ID
                }
                console.log("Firebase autentiserad. Anv칛ndar-ID:", currentUserId);
                setupUserChatListener(); // Starta chatt-lyssnaren f칬rst efter autentisering
            } else {
                currentUserId = 'anonymous'; // Fallback
                const userIdDisplay = document.getElementById('currentUserId');
                 if (userIdDisplay) {
                    userIdDisplay.textContent = currentUserId + ' (ikke logget inn)';
                }
                console.log("Firebase: Ingen anv칛ndare inloggad.");
            }
        });

        // Exponera globalt f칬r anv칛ndning i script-taggen
        window.db = db;
        window.auth = auth;
        window.currentUserId = currentUserId;
        window.serverTimestamp = serverTimestamp;
        window.collection = collection;
        window.addDoc = addDoc;
        window.query = query;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
        window.getDocs = getDocs; // Legg til getDocs
        window.doc = doc; // Legg til doc
        window.deleteDoc = deleteDoc; // Legg til deleteDoc

        // Initialisera Firebase autentisering vid sidladdning
        authenticateFirebase();

    </script>


    <script>
        // Referanse til spillomr친det
        const gameArea = document.getElementById('gameArea');
        const userChatContainer = document.getElementById('userChatContainer'); // Referanse til brukerchat-containeren
        // AI Chat container er fjernet/skjult permanent i denne layouten.

        // requestAnimationFrame ID for Pong, so it can be cancelled
        let pongAnimationFrameId = null;

        // Funksjon for 친 laste et spill inn i spillomr친det
        function loadGame(gameName) {
            gameArea.innerHTML = ''; // T칮mmer spillomr친det
            // Stopp alle aktive spill-looper f칮r et nytt spill lastes
            stopAllGameLoops();

            // S칮rg for at spillomr친det alltid er synlig i denne layouten
            gameArea.classList.remove('hidden');

            switch (gameName) {
                case 'guessTheNumber':
                    loadGuessTheNumberGame();
                    break;
                case 'questionGame': // Denne knappen er n친 fjernet fra main menu
                    loadQuestionGame();
                    break;
                case 'retroGames': // Denne knappen er n친 fjernet fra main menu
                    loadRetroGamesMenu();
                    break;
                case 'snakeGame':
                    loadSnakeGame();
                    break;
                case 'pongGame':
                    loadPongGame();
                    break;
                // AI Chat og Bruker Chat er n친 faste elementer, ikke lastet inn i gameArea
                default:
                    gameArea.innerHTML = '<p>Velg et spill for 친 starte!</p>';
            }
        }

        // Funksjon for 친 stoppe alle aktive spill-looper
        function stopAllGameLoops() {
            // Snake game loop
            if (snakeGameLoopId) {
                clearTimeout(snakeGameLoopId);
                snakeGameLoopId = null;
            }
            // Pong game loop
            if (pongAnimationFrameId) {
                cancelAnimationFrame(pongAnimationFrameId);
                pongAnimationFrameId = null;
            }
            // Fjern event listeners for spillkontroller
            document.removeEventListener('keydown', changeDirection);
            document.removeEventListener('keydown', handlePongKeyPress);
            document.removeEventListener('keyup', handlePongKeyRelease);
        }


        // --- Gjett Tallet-spillet ---
        function loadGuessTheNumberGame() {
            gameArea.innerHTML = `
                <div id="guessTheNumberGame" class="w-full max-w-md p-4 flex flex-col items-center">
                    <h2>GJETT TALLET!</h2>
                    <p class="text-lg mb-4 mt-4">JEG TENKER P칀 ET TALL MELLOM 1 OG 100.</p>
                    <input type="number" id="guessInput" placeholder="SKRIV INN DITT GJETNING" min="1" max="100" class="w-full max-w-xs">
                    <button onclick="checkGuess()" class="mt-4 w-full max-w-xs">GJETT!</button>
                    <p id="gameMessage" class="text-gray-200 mt-4"></p>
                    <p id="attemptsCount" class="text-gray-400"></p>
                    <button onclick="resetGuessTheNumberGame()" class="mt-6 w-full max-w-xs">START NYTT SPILL</button>
                </div>
            `;

            secretNumber = generateRandomNumber(1, 100);
            attempts = 0;
            updateGuessTheNumberUI();
            console.log("Secret number (for testing):", secretNumber);
        }

        let secretNumber;
        let attempts;

        function generateRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function updateGuessTheNumberUI() {
            document.getElementById('attemptsCount').textContent = `ANTALL FORS칒K: ${attempts}`;
        }

        function checkGuess() {
            const guessInput = document.getElementById('guessInput');
            const gameMessage = document.getElementById('gameMessage');
            const guess = parseInt(guessInput.value);

            if (isNaN(guess) || guess < 1 || guess > 100) {
                gameMessage.textContent = "VENNLIGST SKRIV INN ET GYLDIG TALL MELLOM 1 OG 100.";
                gameMessage.style.color = '#FF00FF'; /* Magenta for feil */
                return;
            }

            attempts++;
            updateGuessTheNumberUI();

            if (guess === secretNumber) {
                gameMessage.textContent = `GRATULERER! DU GJETTET RIKTIG TALL (${secretNumber}) P칀 ${attempts} FORS칒K!`;
                gameMessage.style.color = '#00FF00'; /* Gr칮nn for riktig */
                guessInput.disabled = true;
            } else if (guess < secretNumber) {
                gameMessage.textContent = "FOR LAVT! PR칒V ET H칒YERE TALL.";
                gameMessage.style.color = '#FFFF00'; /* Gul for hint */
            } else {
                gameMessage.textContent = "FOR H칒YT! PR칒V ET LAVERE TALL.";
                gameMessage.style.color = '#FFFF00'; /* Gul for hint */
            }

            guessInput.value = '';
            guessInput.focus();
        }

        function resetGuessTheNumberGame() {
            secretNumber = generateRandomNumber(1, 100);
            attempts = 0;
            document.getElementById('guessInput').value = '';
            document.getElementById('guessInput').disabled = false;
            document.getElementById('gameMessage').textContent = '';
            updateGuessTheNumberUI();
            console.log("Secret number (for testing):", secretNumber);
        }

        // --- Sp칮rsm친lsspillet (Ikke lenger i meny, men beholdt funksjonalitet) ---
        let questions = [];
        let currentQuestionIndex;
        let correctAnswers = 0;
        let totalQuestionsAsked = 0;
        const LEADERBOARD_KEY = 'questionGameLeaderboard';

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function loadQuestionGame() {
            gameArea.innerHTML = `
                <div id="questionGame" class="w-full max-w-lg p-4 flex flex-col items-center">
                    <h2>SP칒RSM칀LSSPILL!</h2>
                    <p id="questionDisplay" class="mb-4 mt-4"></p>
                    <input type="text" id="answerInput" placeholder="SKRIV INN DITT SVAR HER" class="w-full max-w-md">
                    <div class="button-group flex justify-center mt-4 gap-4">
                        <button onclick="checkQuestionAnswer()">SVAR</button>
                        <button onclick="nextQuestion()">NESTE SP칒RSM칀L</button>
                    </div>
                    <p id="answerMessage" class="text-gray-200 mt-4"></p>
                    <p id="scoreDisplay" class="text-gray-400 mt-2">POENG: 0 / 0</p>
                    <button onclick="resetQuestionGame()" class="mt-6 w-full max-w-xs">START NYTT SPILL</button>
                </div>

                <div id="leaderboard-container" class="mt-8 retro-box w-full max-w-md">
                    <h3 class="text-xl font-bold text-center" style="color: #00FFFF; text-shadow: 0 0 5px rgba(0, 255, 255, 0.6);">RESULTATLISTE</h3>
                    <ol id="leaderboardList" class="mt-4"></ol>
                </div>
            `;

            initializeQuestionGame();
            loadAndDisplayLeaderboard();
        }

        function initializeQuestionGame() {
            const allQuestions = [
                { question: "HVA ER HOVEDSTADEN I NORGE?", answer: "Oslo" },
                { question: "HVILKET GRUNNSTOFF HAR KJEMISK SYMBOL 'O'?", answer: "Oksygen" },
                { question: "HVA HETER VERDENS ST칒RSTE HAV?", answer: "Stillehavet" },
                { question: "HVILKEN PLANET ER KJENT SOM 'DEN R칒DE PLANET'?", answer: "Mars" },
                { question: "HVEM SKREV 'PEER GYNT'?", answer: "Henrik Ibsen" },
                { question: "HVOR MANGE DAGER ER DET I ET SKUDD칀R?", answer: "366" },
                { question: "HVA ER RESULTATET AV 7 X 8?", answer: "56" },
                { question: "HVILKEN FUGL ER ET SYMBOL FOR FRED?", answer: "Due" },
                { question: "HVA HETER DEN H칒YESTE FJELLTOPPEN I VERDEN?", answer: "Mount Everest" },
                { question: "HVILKET DYR GIR OSS ULL?", answer: "Sau" },
                { question: "HVA HETER NORGES LENGSTE ELV?", answer: "Glomma" },
                { question: "HVILKEN FARGE F칀R DU HVIS DU BLANDER BL칀TT OG GULT?", answer: "Gr칮nn" },
                { question: "HVA HETER DET ST칒RSTE ORGANET I MENNESKEKROPPEN?", answer: "Hud" },
                { question: "HVA HETER VALUTAEN I JAPAN?", answer: "Yen" },
                { question: "HVILKEN SPORT BRUKER EN PUCK?", answer: "Ishockey" },
                { question: "HVA ER HOVEDSTADEN I SVERIGE?", answer: "Stockholm" },
                { question: "HVILKEN M칀NED HAR 28 DAGER (UTENOM SKUDD칀R)?", answer: "Februar" },
                { question: "HVA HETER DYRET SOM ER EN 'KONGLE-SPISER'?", answer: "Eiken칮tt" },
                { question: "HVA ER MOTSATT AV 'KALD'?", answer: "Varm" },
                { question: "HVILKEN BY ER KJENT FOR EIFFELT칀RNET?", answer: "Paris" },
                { question: "HVA HETER HAVNEN I BERGEN?", answer: "Bryggen" },
                { question: "HVILKET INSTRUMENT HAR 88 TANGENTER?", answer: "Piano" },
                { question: "HVA ER ET ANNET NAVN FOR ET 'SEKSKANTET' OBJEKT?", answer: "Heksagon" },
                { question: "HVILKEN TYPE FRUKT ER EN BANAN?", answer: "B칝r" },
                { question: "HVA ER DEN ST칒RSTE 칒RKENEN I VERDEN?", answer: "Sahara" },
                { question: "HVEM MALTE 'SKRIK'?", answer: "Edvard Munch" },
                { question: "HVA HETER NORGES NASJONALFUGL?", answer: "Fossekall" },
                { question: "HVOR MANGE BEIN HAR EN EDDERKOPP?", answer: "8" },
                { question: "HVA ER DEN OFFISIELLE HOVEDSTADEN I CANADA?", answer: "Ottawa" },
                { question: "HVILKET HAV SKILLER EUROPA OG AFRIKA?", answer: "Middelhavet" },
                { question: "HVA HETER FIKTIVE KARAKTEREN SOM BOR I EN ANANAS UNDER HAVET?", answer: "Svampebob Firkant" },
                { question: "HVA ER DET H칒YESTE BYGGET I VERDEN?", answer: "Burj Khalifa" },
                { question: "HVILKEN FARGE ER SOLSIKKER?", answer: "Gul" },
                { question: "HVA HETER DET F칒RSTE MENNESKET P칀 M칀NEN?", answer: "Neil Armstrong" },
                { question: "HVILKET LAND ER KJENT FOR PIZZA OG PASTA?", answer: "Italia" },
                { question: "HVA ER EN GRUPPE L칒VER KALT?", answer: "Stolthet" },
                { question: "HVILKEN METALL ER FLYTENDE VED ROMTEMPERATUR?", answer: "Kvikks칮lv" },
                { question: "HVA ER HOVEDSTADEN I TYSKLAND?", answer: "Berlin" },
                { question: "HVA HETER DET ST칒RSTE PATTEDYR I VERDEN?", answer: "Bl친hval" },
                { question: "HVA ER DET MEST VANLIGE NAVNET I VERDEN?", answer: "Mohammed" },
                { question: "HVA HETER ELVEN SOM RENNER GJENNOM LONDON?", answer: "Themsen" },
                { question: "HVA ER DET MINSTE LANDET I VERDEN?", answer: "Vatikanstaten" },
                { question: "HVA HETER DEN ST칒RSTE 칒YA I VERDEN?", answer: "Gr칮nland" },
                { question: "HVA ER HOVEDINGREDIENSEN I GUACAMOLE?", answer: "Avocado" },
                { question: "HVILKEN PLANET ER N칁RMEST SOLEN?", answer: "Mercur" },
                { question: "HVA ER DET KJEMISKE SYMBOLET FOR VANN?", answer: "H2O" },
                { question: "HVILKEN FARGE ER HIMMELEN P칀 EN KLAR DAG?", answer: "Bl친" },
                { question: "HVILKET DYR ER KJENT FOR 칀 BYGGE DEMNINGER?", answer: "Bever" },
                { question: "HVA HETER SPORTEN DER MAN KASTER EN JAVELIN?", answer: "Spydkast" },
                { question: "HVILKEN DEL AV ET TRE LEDER VANN OPP TIL BLADENE?", answer: "Stamme" }
            ];

            questions = [...allQuestions];
            shuffleArray(questions);
            currentQuestionIndex = -1;
            correctAnswers = 0;
            totalQuestionsAsked = 0;
            nextQuestion();
            updateQuestionScore();
        }

        function checkQuestionAnswer() {
            const answerInput = document.getElementById('answerInput');
            const answerMessage = document.getElementById('answerMessage');
            const userAnswer = answerInput.value.trim().toLowerCase();
            const correctAnswer = questions[currentQuestionIndex].answer.trim().toLowerCase();

            if (answerInput.disabled) {
                return;
            }

            totalQuestionsAsked++;

            if (userAnswer === correctAnswer) {
                answerMessage.textContent = "RIKTIG SVAR! 游꿀";
                answerMessage.style.color = '#00FF00'; /* Gr칮nn */
                correctAnswers++;
            } else {
                answerMessage.textContent = `FEIL SVAR. SVARET VAR: ${questions[currentQuestionIndex].answer.toUpperCase()}`;
                answerMessage.style.color = '#FF00FF'; /* Magenta */
            }
            answerInput.disabled = true;
            updateQuestionScore();
        }

        function nextQuestion() {
            const answerMessage = document.getElementById('answerMessage');
            const answerInput = document.getElementById('answerInput');

            if (currentQuestionIndex >= 0 && !answerInput.disabled && currentQuestionIndex < questions.length) {
                 totalQuestionsAsked++;
                 answerMessage.textContent = `DU HOPPET OVER DETTE. SVARET VAR: ${questions[currentQuestionIndex].answer.toUpperCase()}`;
                 answerMessage.style.color = '#FFFF00'; /* Gul */
                 updateQuestionScore();
            }

            currentQuestionIndex++;
            displayQuestion();
        }

        function updateQuestionScore() {
            document.getElementById('scoreDisplay').textContent = `POENG: ${correctAnswers} / ${totalQuestionsAsked}`;
        }

        function resetQuestionGame() {
            initializeQuestionGame();
            document.getElementById('answerMessage').textContent = '';
        }

        // --- Resultatliste (Leaderboard) funksjoner ---
        function getLeaderboard() {
            const leaderboardJson = localStorage.getItem(LEADERBOARD_KEY);
            return leaderboardJson ? JSON.parse(leaderboardJson) : [];
        }

        function saveLeaderboard(leaderboardData) {
            localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboardData));
        }

        function addScoreToLeaderboard(nickname, score, total) {
            let leaderboard = getLeaderboard();
            leaderboard.push({ nickname: nickname, score: score, totalQuestions: total });

            leaderboard.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return a.totalQuestions - b.totalQuestions;
            });

            leaderboard = leaderboard.slice(0, 5);
            saveLeaderboard(leaderboard);
            loadAndDisplayLeaderboard();
        }

        function loadAndDisplayLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) return;

            const leaderboard = getLeaderboard();
            leaderboardList.innerHTML = '';

            if (leaderboard.length === 0) {
                leaderboardList.innerHTML = '<li class="text-center text-gray-400">INGEN RESULTATER ENN칀. SPILL FOR 칀 KOMME P칀 LISTEN!</li>';
                return;
            }

            leaderboard.forEach((entry, index) => {
                const listItem = document.createElement('li');
                listItem.className = "flex justify-between items-center bg-transparent border-b border-dashed border-gray-700 py-1";
                listItem.innerHTML = `
                    <span class="text-cyan-400">${index + 1}. ${entry.nickname.toUpperCase()}</span>
                    <span class="text-yellow-400">${entry.score} / ${entry.totalQuestions}</span>
                `;
                leaderboardList.appendChild(listItem);
            });
        }

        function showNicknameInput() {
            const questionGameDiv = document.getElementById('questionGame');
            const nicknameInputContainer = document.createElement('div');
            nicknameInputContainer.id = 'nicknameInputContainer';
            nicknameInputContainer.className = 'mt-6 retro-box w-full max-w-md p-4';
            nicknameInputContainer.innerHTML = `
                <p class="text-center mb-2">GRATULERER! SKRIV INN DITT KALLENAVN FOR RESULTATLISTEN:</p>
                <input type="text" id="nicknameInput" placeholder="KALLENAVN" class="w-full mb-2">
                <button onclick="submitNickname()" class="w-full">LAGRE POENGSUM</button>
            `;
            questionGameDiv.appendChild(nicknameInputContainer);
            document.getElementById('nicknameInput').focus();
        }

        function submitNickname() {
            const nicknameInput = document.getElementById('nicknameInput');
            let nickname = nicknameInput.value.trim();

            if (nickname === "") {
                nickname = "ANONYM";
            }

            addScoreToLeaderboard(nickname, correctAnswers, totalQuestionsAsked);

            const nicknameInputContainer = document.getElementById('nicknameInputContainer');
            if (nicknameInputContainer) {
                nicknameInputContainer.remove();
            }
            const answerMessage = document.getElementById('answerMessage');
            answerMessage.textContent = `POENGSUM LAGRET UNDER ${nickname.toUpperCase()}!`;
            answerMessage.style.color = '#00FF00';
        }

        // --- Retro Games Menu (Ikke lenger i meny, men beholdt funksjonalitet) ---
        function loadRetroGamesMenu() {
            gameArea.innerHTML = `
                <div class="w-full max-w-2xl p-4">
                    <h2 class="text-3xl font-bold text-center mb-6">90-TALLS RETRO SPILL</h2>
                    <div class="game-menu-retro">
                        <button class="retro-button" onclick="loadGame('snakeGame')">SNAKE</button>
                        <button class="retro-button" onclick="loadGame('pongGame')">PONG</button>
                        <button class="retro-button" disabled>TETRIS LITE (KOMMER)</button>
                        <button class="retro-button" disabled>PAC-MAN LITE (KOMMER)</button>
                        <button class="retro-button" disabled>SPACE INVADERS LITE (KOMMER)</button>
                        <button class="retro-button" disabled>BRICK BREAKER (KOMMER)</button>
                        <button class="retro-button" disabled>FROGGER LITE (KOMMER)</button>
                        <button class="retro-button" disabled>CONNECT FOUR (KOMMER)</button>
                        <button class="retro-button" disabled>TIC-TAC-TOE (KOMMER)</button>
                        <button class="retro-button" disabled>MINESWEEPER LITE (KOMMER)</button>
                        <button class="retro-button" disabled>SIMON SAYS (KOMMER)</button>
                        <button class="retro-button" disabled>WHACK-A-MOLE (KOMMER)</button>
                        <button class="retro-button" disabled>FLAPPY BIRD (KOMMER)</button>
                        <button class="retro-button" disabled>CROSSY ROAD (KOMMER)</button>
                        <button class="retro-button" disabled>ENDLESS RUNNER (KOMMER)</button>
                        <button class="retro-button" disabled>PINBALL LITE (KOMMER)</button>
                        <button class="retro-button" disabled>HANGMAN (KOMMER)</button>
                        <button class="retro-button" disabled>GUESS THE WORD (KOMMER)</button>
                        <button class="retro-button" disabled>ROCK-PAPER-SCISSORS (KOMMER)</button>
                        <button class="retro-button" disabled>MEMORY GAME (KOMMER)</button>
                        <button class="retro-button" disabled>SUDOKU (KOMMER)</button>
                        <button class="retro-button" disabled>BATTLESHIP LITE (KOMMER)</button>
                        <button class="retro-button" disabled>MASTERMIND (KOMMER)</button>
                        <button class="retro-button" disabled>2048 (KOMMER)</button>
                        <button class="retro-button" disabled>DOODLE JUMP (KOMMER)</button>
                    </div>
                </div>
            `;
        }


        // --- Snake Game ---
        let snakeCanvas, snakeCtx;
        const GRID_SIZE = 20;
        let snake = [{ x: 10, y: 10 }];
        let food = {};
        let dx = 0;
        let dy = 0;
        let score = 0;
        let changingDirection = false;
        let snakeGameLoopId = null;

        function loadSnakeGame() {
            gameArea.innerHTML = `
                <div id="snakeGame" class="w-full max-w-lg p-4 flex flex-col items-center">
                    <h2>SNAKE</h2>
                    <canvas id="snakeCanvas" width="400" height="400"></canvas>
                    <div id="snakeGameControls" class="mt-4 flex gap-4">
                        <button onclick="startGame()">START SPILL</button>
                        <button onclick="pauseGame()">PAUSE/FORTSETT</button>
                        <button onclick="resetSnakeGame()">NYTT SPILL</button>
                    </div>
                    <p id="snakeScore" class="mt-4">POENG: 0</p>
                </div>
            `;
            snakeCanvas = document.getElementById('snakeCanvas');
            snakeCtx = snakeCanvas.getContext('2d');
            resetSnakeGame();
            document.addEventListener('keydown', changeDirection);
        }

        function createFood() {
            food = {
                x: Math.floor(Math.random() * (snakeCanvas.width / GRID_SIZE)),
                y: Math.floor(Math.random() * (snakeCanvas.height / GRID_SIZE))
            };
            snake.forEach(part => {
                if (part.x === food.x && part.y === food.y) {
                    createFood();
                }
            });
        }

        function drawSnakePart(snakePart) {
            snakeCtx.fillStyle = '#00FF00'; /* Neon gr칮nn for slange */
            snakeCtx.strokeStyle = '#00BB00'; /* M칮rkere gr칮nn */
            snakeCtx.fillRect(snakePart.x * GRID_SIZE, snakePart.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
            snakeCtx.strokeRect(snakePart.x * GRID_SIZE, snakePart.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
        }

        function drawFood() {
            snakeCtx.fillStyle = '#FF00FF'; /* Neon magenta for mat */
            snakeCtx.strokeStyle = '#BB00BB';
            snakeCtx.fillRect(food.x * GRID_SIZE, food.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
            snakeCtx.strokeRect(food.x * GRID_SIZE, food.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
        }

        function draw() {
            snakeCtx.clearRect(0, 0, snakeCanvas.width, snakeCanvas.height);
            drawFood();
            snake.forEach(drawSnakePart);
        }

        function advanceSnake() {
            if (snakeGameLoopId === null && (dx === 0 && dy === 0)) return;

            const head = { x: snake[0].x + dx, y: snake[0].y + dy };

            if (
                head.x < 0 || head.x * GRID_SIZE >= snakeCanvas.width ||
                head.y < 0 || head.y * GRID_SIZE >= snakeCanvas.height ||
                checkCollision(head)
            ) {
                gameOver("GAME OVER! DITT POENG: " + score);
                return;
            }

            snake.unshift(head);

            const didEatFood = head.x === food.x && head.y === food.y;
            if (didEatFood) {
                score += 10;
                document.getElementById('snakeScore').textContent = `POENG: ${score}`;
                createFood();
            } else {
                snake.pop();
            }
            changingDirection = false;
        }

        function checkCollision(head) {
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) return true;
            }
            return false;
        }

        function changeDirection(event) {
            const LEFT_KEY = 37;
            const RIGHT_KEY = 39;
            const UP_KEY = 38;
            const DOWN_KEY = 40;

            if (changingDirection) return;
            changingDirection = true;

            const keyPressed = event.keyCode;
            const goingUp = dy === -1;
            const goingDown = dy === 1;
            const goingLeft = dx === -1;
            const goingRight = dx === 1;

            if (keyPressed === LEFT_KEY && !goingRight) {
                dx = -1;
                dy = 0;
            }
            if (keyPressed === UP_KEY && !goingDown) {
                dx = 0;
                dy = -1;
            }
            if (keyPressed === RIGHT_KEY && !goingLeft) {
                dx = 1;
                dy = 0;
            }
            if (keyPressed === DOWN_KEY && !goingUp) {
                dx = 0;
                dy = 1;
            }
        }

        function gameLoop() {
            snakeGameLoopId = setTimeout(function onTick() {
                advanceSnake();
                draw();
                gameLoop();
            }, 100);
        }

        function startGame() {
            if (snakeGameLoopId === null) {
                if (dx === 0 && dy === 0) {
                     dx = 1;
                }
                gameLoop();
            }
        }

        function pauseGame() {
            if (snakeGameLoopId) {
                clearTimeout(snakeGameLoopId);
                snakeGameLoopId = null;
            } else {
                startGame();
            }
        }

        function resetSnakeGame() {
            clearTimeout(snakeGameLoopId);
            snakeGameLoopId = null;
            snake = [{ x: 10, y: 10 }];
            dx = 0;
            dy = 0;
            score = 0;
            document.getElementById('snakeScore').textContent = `POENG: ${score}`;
            createFood();
            draw();
        }

        function gameOver(message) {
            clearTimeout(snakeGameLoopId);
            snakeGameLoopId = null;
            document.getElementById('snakeScore').textContent = message;
        }

        // --- Pong Game ---
        let pongCanvas, pongCtx;
        let paddle1, paddle2, ball;
        let player1Score, player2Score;
        let pongMessageElement;
        let pongScoreElement;

        const keysPressed = {};

        function loadPongGame() {
            gameArea.innerHTML = `
                <div id="pongGame" class="w-full max-w-lg p-4 flex flex-col items-center">
                    <h2>PONG</h2>
                    <canvas id="pongCanvas" width="500" height="300"></canvas>
                    <div id="pongGameControls" class="mt-4 flex gap-4">
                        <button onclick="startGamePong()">START SPILL</button>
                        <button onclick="resetPongGame()">NYTT SPILL</button>
                    </div>
                    <p id="pongScore" class="mt-4">POENG: SPILLER 1: 0 - SPILLER 2: 0</p>
                    <p id="pongMessage" class="mt-2"></p>
                    <div class="pong-controls-info">
                        <p>KONTROLLER:</p>
                        <p>SPILLER 1 (VENSTRE): W (OPP), S (NED)</p>
                        <p>SPILLER 2 (H칒YRE): PIL OPP, PIL NED</p>
                    </div>
                </div>
            `;
            pongCanvas = document.getElementById('pongCanvas');
            pongCtx = pongCanvas.getContext('2d');
            pongMessageElement = document.getElementById('pongMessage');
            pongScoreElement = document.getElementById('pongScore');

            document.addEventListener('keydown', handlePongKeyPress);
            document.addEventListener('keyup', handlePongKeyRelease);

            resetPongGame();
        }

        function initPongObjects() {
            paddle1 = { x: 10, y: pongCanvas.height / 2 - 30, width: 10, height: 60, dy: 0, color: '#00FFFF' }; /* Neon cyan */
            paddle2 = { x: pongCanvas.width - 20, y: pongCanvas.height / 2 - 30, width: 10, height: 60, dy: 0, color: '#FF00FF' }; /* Neon magenta */
            ball = { x: pongCanvas.width / 2, y: pongCanvas.height / 2, radius: 7, dx: 0, dy: 0, color: '#FFFF00' }; /* Neon gul */
        }

        function resetPongGame() {
            if (pongAnimationFrameId) {
                cancelAnimationFrame(pongAnimationFrameId);
            }
            pongAnimationFrameId = null;

            player1Score = 0;
            player2Score = 0;
            updatePongScore();
            pongMessageElement.textContent = "TRYKK 'START SPILL' FOR 칀 BEGYNNE!";
            initPongObjects();
            drawPong();
        }

        function serveBall() {
            ball.x = pongCanvas.width / 2;
            ball.y = pongCanvas.height / 2;
            ball.dx = (Math.random() > 0.5 ? 3 : -3) * (Math.random() > 0.5 ? 1 : 1);
            ball.dy = (Math.random() * 2 - 1) * 2;
        }

        function drawPong() {
            pongCtx.fillStyle = 'black';
            pongCtx.fillRect(0, 0, pongCanvas.width, pongCanvas.height);

            pongCtx.strokeStyle = '#00FFFF'; /* Neon cyan midtlinje */
            pongCtx.beginPath();
            pongCtx.setLineDash([5, 5]);
            pongCtx.moveTo(pongCanvas.width / 2, 0);
            pongCtx.lineTo(pongCanvas.width / 2, pongCanvas.height);
            pongCtx.stroke();
            pongCtx.setLineDash([]);

            pongCtx.fillStyle = paddle1.color;
            pongCtx.fillRect(paddle1.x, paddle1.y, paddle1.width, paddle1.height);
            pongCtx.fillStyle = paddle2.color;
            pongCtx.fillRect(paddle2.x, paddle2.y, paddle2.width, paddle2.height);

            pongCtx.beginPath();
            pongCtx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            pongCtx.fillStyle = ball.color;
            pongCtx.fill();
        }

        function updatePong() {
            paddle1.y += paddle1.dy;
            paddle2.y += paddle2.dy;

            if (paddle1.y < 0) paddle1.y = 0;
            if (paddle1.y + paddle1.height > pongCanvas.height) paddle1.y = pongCanvas.height - paddle1.height;
            if (paddle2.y < 0) paddle2.y = 0;
            if (paddle2.y + paddle2.height > pongCanvas.height) paddle2.y = pongCanvas.height - paddle2.height;

            ball.x += ball.dx;
            ball.y += ball.dy;

            if (ball.y - ball.radius < 0 || ball.y + ball.radius > pongCanvas.height) {
                ball.dy = -ball.dy;
            }

            if (ball.dx < 0 &&
                ball.x - ball.radius < paddle1.x + paddle1.width &&
                ball.y > paddle1.y &&
                ball.y < paddle1.y + paddle1.height) {
                ball.dx = -ball.dx;
                let collidePoint = ball.y - (paddle1.y + paddle1.height / 2);
                collidePoint = collidePoint / (paddle1.height / 2);
                ball.dy = collidePoint * 5;
            }
            else if (ball.dx > 0 &&
                     ball.x + ball.radius > paddle2.x &&
                     ball.y > paddle2.y &&
                     ball.y < paddle2.y + paddle2.height) {
                ball.dx = -ball.dx;
                let collidePoint = ball.y - (paddle2.y + paddle2.height / 2);
                collidePoint = collidePoint / (paddle2.height / 2);
                ball.dy = collidePoint * 5;
            }

            if (ball.x - ball.radius < 0) {
                player2Score++;
                updatePongScore();
                if (player2Score >= 5) {
                    gameOverPong("SPILLER 2 VANT! 游끥");
                } else {
                    serveBall();
                }
            } else if (ball.x + ball.radius > pongCanvas.width) {
                player1Score++;
                updatePongScore();
                if (player1Score >= 5) {
                    gameOverPong("SPILLER 1 VANT! 游끥");
                } else {
                    serveBall();
                }
            }
        }

        function updatePongScore() {
            pongScoreElement.textContent = `POENG: SPILLER 1: ${player1Score} - SPILLER 2: ${player2Score}`;
        }

        function gameOverPong(message) {
            if (pongAnimationFrameId) {
                cancelAnimationFrame(pongAnimationFrameId);
                pongAnimationFrameId = null;
            }
            pongMessageElement.textContent = message;
        }

        function pongGameLoop() {
            updatePong();
            drawPong();
            pongAnimationFrameId = requestAnimationFrame(pongGameLoop);
        }

        function startGamePong() {
            if (pongAnimationFrameId) {
                return;
            }
            pongMessageElement.textContent = "";
            serveBall();
            pongGameLoop();
        }

        function handlePongKeyPress(event) {
            keysPressed[event.key] = true;
            if (pongAnimationFrameId === null) return;

            if (keysPressed['w'] || keysPressed['W']) {
                paddle1.dy = -5;
            } else if (keysPressed['s'] || keysPressed['S']) {
                paddle1.dy = 5;
            }

            if (keysPressed['ArrowUp']) {
                paddle2.dy = -5;
            } else if (keysPressed['ArrowDown']) {
                paddle2.dy = 5;
            }
        }

        function handlePongKeyRelease(event) {
            keysPressed[event.key] = false;

            if (!(keysPressed['w'] || keysPressed['W'] || keysPressed['s'] || keysPressed['S'])) {
                paddle1.dy = 0;
            } else if (keysPressed['w'] || keysPressed['W']) {
                paddle1.dy = -5;
            } else if (keysPressed['s'] || keysPressed['S']) {
                paddle1.dy = 5;
            }

            if (!(keysPressed['ArrowUp'] || keysPressed['ArrowDown'])) {
                paddle2.dy = 0;
            } else if (keysPressed['ArrowUp']) {
                paddle2.dy = -5;
            } else if (keysPressed['ArrowDown']) {
                paddle2.dy = 5;
            }
        }

        // --- AI Chat (Removed from this visual layout to match image) ---
        // Functions and variables are kept but not called by the UI.
        let chatHistory = [];
        const AI_CHAT_HISTORY_KEY = 'aiChatHistory';
        const tools = []; // Tools will not be used in this simplified UI

        function displayAIChatMessage(message, type) { /* No-op in this UI */ }
        function loadAIChatHistory() { /* No-op in this UI */ }
        function saveAIChatHistory() { /* No-op in this UI */ }
        function resetAIChat() { /* No-op in this UI */ }
        async function sendMessage() { /* No-op in this UI */ }
        async function googleSearch(queries) { /* No-op in this UI */ return []; }

        // --- Bruker Chat (Firestore) ---
        let userChatUnsubscribe = null;

        // Note: userChatContainer is no longer hidden/shown by loadGame.
        // It's a persistent bottom element now, managed by its own init logic.

        // The user ID display is updated when Firebase Auth is ready in the module script.
        // `userChatContainer` is always present, no need to hide/show its class.
        // The `showUserChatPanel` and `hideUserChatPanel` functions are removed
        // as the user chat is now a permanent fixture matching the image.

        function displayUserChatMessage(message, userId, timestamp) {
            const userChatOutput = document.getElementById('userChatOutput');
            if (!userChatOutput) return; // Ensure element exists

            const messageDiv = document.createElement('div');
            
            let messageClass = 'user-chat-message';
            // Use the actual currentUserId from the global window scope
            if (userId === window.currentUserId) {
                messageClass = 'current-user-chat-message';
            }

            const date = timestamp ? new Date(timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'N칀';
            
            messageDiv.className = `chat-message ${messageClass}`;
            messageDiv.innerHTML = `<span class="font-bold text-xs">${userId}</span> <span class="text-xs text-gray-200">${date}</span><br>${message.toUpperCase()}`; // Show full ID, capitalize message
            userChatOutput.appendChild(messageDiv);
            userChatOutput.scrollTop = userChatOutput.scrollHeight;
        }

        function setupUserChatListener() {
            if (userChatUnsubscribe) {
                userChatUnsubscribe();
            }

            // Check if db and appId are available from the module script
            if (!window.db || !window.__app_id) {
                console.error("Firebase DB or App ID not available for chat listener.");
                document.getElementById('userChatOutput').innerHTML = '<div class="chat-message ai-message text-red-400">FEIL: KAN IKKE KOBLE TIL CHAT.</div>';
                return;
            }

            // Check if current user is authenticated before setting up listener
            if (!window.auth.currentUser) {
                console.warn("Firebase Auth not ready for User Chat listener. Waiting for authentication.");
                document.getElementById('userChatOutput').innerHTML = '<div class="chat-message ai-message" style="color: #FFFF00;">VENTER P칀 AUTENTISERING FOR CHAT...</div>';
                return;
            }

            const chatCollectionRef = window.collection(window.db, `artifacts/${window.__app_id}/public/data/user_chats`);
            const q = window.query(chatCollectionRef, window.orderBy('timestamp', 'asc'));

            userChatUnsubscribe = window.onSnapshot(q, (snapshot) => {
                const userChatOutput = document.getElementById('userChatOutput');
                userChatOutput.innerHTML = ''; // T칮m for 친 laste inn p친 nytt
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    displayUserChatMessage(data.message, data.userId, data.timestamp);
                });
            }, (error) => {
                console.error("Feil ved henting av chatmeldinger:", error);
                document.getElementById('userChatOutput').innerHTML = '<div class="chat-message ai-message text-red-400">FEIL VED LASTING AV CHATMELDINGER.</div>';
            });
            console.log("User chat listener subscribed.");
        }


        async function sendMessageUserChat() {
            const userChatInput = document.getElementById('userChatInput');
            const userChatSendButton = document.getElementById('userChatSendButton');
            const userChatLoadingIndicator = document.getElementById('userChatLoadingIndicator');
            const message = userChatInput.value.trim();

            if (message === '' || !window.auth.currentUser) {
                console.warn("Melding er tom eller bruker er ikke autentisert.");
                return;
            }

            userChatInput.value = '';
            userChatSendButton.disabled = true;
            userChatLoadingIndicator.classList.remove('hidden');

            try {
                const chatCollectionRef = window.collection(window.db, `artifacts/${window.__app_id}/public/data/user_chats`);
                await window.addDoc(chatCollectionRef, {
                    userId: window.currentUserId,
                    message: message,
                    timestamp: window.serverTimestamp()
                });
            } catch (error) {
                console.error("Feil ved sending av melding:", error);
                // Optionally display error in chat output
                document.getElementById('userChatOutput').appendChild(document.createElement('div')).outerHTML = 
                    `<div class="chat-message ai-message" style="color: #FF00FF;">FEIL VED SENDING AV MELDING.</div>`;
            } finally {
                userChatSendButton.disabled = false;
                userChatLoadingIndicator.classList.add('hidden');
                userChatInput.focus();
            }
        }

        async function clearUserChat() {
            // Using a simple message box instead of confirm()
            const confirmClear = document.createElement('div');
            confirmClear.className = "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50";
            confirmClear.innerHTML = `
                <div class="retro-box p-8 max-w-sm mx-auto text-center">
                    <p class="mb-4">ER DU SIKKER P칀 AT DU VIL T칒MME HELE CHAT-HISTORIKKEN FOR ALLE BRUKERE? DENNE HANDLINGEN KAN IKKE ANGRERES.</p>
                    <button id="confirmClearBtn" class="retro-button mr-2">JA</button>
                    <button id="cancelClearBtn" class="retro-button">AVBRYT</button>
                </div>
            `;
            document.body.appendChild(confirmClear);

            return new Promise(resolve => {
                document.getElementById('confirmClearBtn').onclick = async () => {
                    document.body.removeChild(confirmClear);
                    const userChatOutput = document.getElementById('userChatOutput');
                    if (userChatOutput) {
                        userChatOutput.innerHTML = '<div class="chat-message ai-message" style="color: #FFFF00;">T칒MMER CHAT...</div>'; // Feedback til bruker
                    }
                    try {
                        const chatCollectionRef = window.collection(window.db, `artifacts/${window.__app_id}/public/data/user_chats`);
                        const q = window.query(chatCollectionRef);
                        const querySnapshot = await window.getDocs(q);

                        const deletePromises = [];
                        querySnapshot.forEach((doc) => {
                            deletePromises.push(window.deleteDoc(window.doc(window.db, `artifacts/${window.__app_id}/public/data/user_chats`, doc.id)));
                        });
                        await Promise.all(deletePromises);
                        console.log("Chat historikk t칮mt.");
                        resolve(true); // Indicate success
                    } catch (error) {
                        console.error("Feil ved t칮mming av chat-historikk:", error);
                        if (userChatOutput) {
                            userChatOutput.innerHTML = '<div class="chat-message ai-message text-red-400">FEIL VED T칒MMING AV CHAT.</div>';
                        }
                        resolve(false); // Indicate failure
                    }
                };
                document.getElementById('cancelClearBtn').onclick = () => {
                    document.body.removeChild(confirmClear);
                    resolve(false); // Indicate cancellation
                };
            });
        }


        // Laster "Gjett Tallet"-spillet automatisk n친r siden lastes som standard
        window.onload = () => {
            // S칮rg for at Firebase initialiseres f칮rst, deretter lastes spillet
            // Autentiseringslogikken i type="module" scriptet kj칮rer parallelt.
            // onAuthStateChanged vil kalle setupUserChatListener n친r brukeren er klar.
            loadGame('guessTheNumber');
        };

    </script>
</body>
</html>
