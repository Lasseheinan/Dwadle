<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minispill | Bruk Tid</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for better readability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Mørk bakgrunn */
            color: #f3f4f6; /* Lys tekstfarge */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1.5rem;
            box-sizing: border-box;
        }

        .container {
            background-color: #374151; /* Mørkere grå for hovedcontainer */
            border-radius: 1.5rem; /* runde hjørner */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); /* skygge */
            padding: 2.5rem;
            width: 100%;
            max-width: 900px; /* Maks bredde for lesbarhet */
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 1rem;
        }

        h1 {
            font-size: 3rem; /* Stor tittel */
            font-weight: bold;
            color: #a78bfa; /* Lys lilla */
            margin-bottom: 0.5rem;
        }

        .game-menu {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .game-button {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6); /* Gradient-knapp */
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: none;
            flex: 1 1 auto; /* Fleksibel bredde */
            max-width: 200px; /* Maks bredde for hver knapp */
        }

        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .game-area {
            background-color: #4b5563; /* Lysere grå for spillområdet */
            border-radius: 1rem;
            padding: 2rem;
            min-height: 300px; /* Minimum høyde for spillinnhold */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* Spesifikke stiler for "Gjett Tallet"-spillet */
        #guessTheNumberGame h2 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #34d399; /* Grønn tittel for spillet */
            margin-bottom: 1.5rem;
        }

        #guessTheNumberGame input[type="number"] {
            background-color: #6b7280; /* Mørkere inputfelt */
            color: #f3f4f6;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid #4b5563;
            width: 100%;
            max-width: 200px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.25rem;
        }

        #guessTheNumberGame button {
            background-image: linear-gradient(to right, #10b981, #059669); /* Grønn gradient knapp */
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #guessTheNumberGame button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        #guessTheNumberGame #gameMessage {
            margin-top: 1.5rem;
            font-size: 1.125rem;
            font-weight: 500;
        }

        #guessTheNumberGame #attemptsCount {
            margin-top: 0.5rem;
            font-size: 0.95rem;
            color: #d1d5db; /* Lysere grå tekst */
        }

        /* Spesifikke stiler for "Spørsmålsspill" */
        #questionGame h2 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #fca311; /* Oransje tittel for spillet */
            margin-bottom: 1.5rem;
        }
        #questionGame #questionDisplay {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #e0e7ff; /* Lysere tekst for spørsmål */
            min-height: 3em; /* Sikrer litt plass selv med kort spørsmål */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #questionGame input[type="text"] {
            background-color: #6b7280;
            color: #f3f4f6;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid #4b5563;
            width: 100%;
            max-width: 300px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.25rem;
            focus:outline-none focus:ring-2 focus:ring-yellow-500;
        }
        #questionGame .button-group button {
            background-image: linear-gradient(to right, #f59e0b, #d97706); /* Oransje gradient knapp */
            margin: 0.5rem;
        }
        #questionGame #scoreDisplay {
            margin-top: 1rem;
            font-size: 1rem;
            color: #d1d5db;
        }
        #questionGame #answerMessage {
            margin-top: 1rem;
            font-size: 1.125rem;
            font-weight: 500;
        }
        #leaderboard-container {
            background-color: #374151; /* Mørkere grå */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            width: 100%;
            max-width: 400px; /* Begrenset bredde for lesbarhet */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
            text-align: left;
        }
        #leaderboard-container h3 {
            font-size: 1.75rem;
            font-weight: bold;
            color: #fca311; /* Oransje tittel */
            margin-bottom: 1rem;
            text-align: center;
        }
        #leaderboard-container ol {
            list-style: none; /* Fjern standard liste-prikker */
            padding: 0;
            margin: 0;
        }
        #leaderboard-container li {
            background-color: #4b5563; /* Litt lysere grå for liste-elementer */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            color: #e0e7ff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        #leaderboard-container li:last-child {
            margin-bottom: 0;
        }
        #leaderboard-container .leaderboard-score {
            font-weight: bold;
            color: #34d399; /* Grønn for poeng */
        }
        #nicknameInputContainer {
            margin-top: 1.5rem;
            background-color: #6b7280;
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        #nicknameInputContainer input {
            background-color: #4b5563;
            border: 1px solid #374151;
            color: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        #nicknameInputContainer button {
            background-image: linear-gradient(to right, #8b5cf6, #a78bfa); /* Lilla gradient */
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }

        /* Spesifikke stiler for Retro Spill-seksjonen */
        .retro-game-menu {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            max-width: 600px; /* Passende bredde for retro-meny */
        }

        .retro-game-button {
            background-image: linear-gradient(to right, #06b6d4, #0ea5e9); /* Blå gradient */
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: none;
            flex: 1 1 auto;
            max-width: 180px;
        }

        .retro-game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* Snake Game Canvas */
        #snakeCanvas {
            background-color: #1a4d2e; /* Mørk grønn for slangespillet */
            border: 2px solid #34d399;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        #snakeGameControls {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        #snakeGameControls button {
            background-image: linear-gradient(to right, #a78bfa, #c084fc); /* Lilla gradient */
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #snakeGameControls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #snakeScore {
            margin-top: 1rem;
            font-size: 1.25rem;
            font-weight: bold;
            color: #34d399;
        }

        /* Pong Game Canvas */
        #pongCanvas {
            background-color: #000000; /* Svart bakgrunn for Pong */
            border: 2px solid #e0e7ff; /* Lys kant */
            border-radius: 0.5rem;
        }
        #pongGameControls {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        #pongGameControls button {
            background-image: linear-gradient(to right, #dc2626, #ef4444); /* Rød gradient */
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #pongGameControls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #pongScore {
            margin-top: 1rem;
            font-size: 1.25rem;
            font-weight: bold;
            color: #e0e7ff;
        }
        #pongMessage {
            color: #facc15; /* Gul for meldinger */
            font-weight: 500;
            margin-top: 0.5rem;
        }
        .pong-controls-info {
            text-align: center;
            margin-top: 1rem;
            color: #9ca3af;
            font-size: 0.9rem;
        }


        /* AI Chat spesifikke stiler */
        #aiChat {
            background-color: #2d3748; /* Mørkere grå for chat-bakgrunn */
            padding: 1.5rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 600px; /* Maks bredde for chat */
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        #chatOutput {
            background-color: #1a202c; /* Enda mørkere for chat-historikk */
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 250px;
            max-height: 400px;
            overflow-y: auto;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            color: #e2e8f0;
            line-height: 1.5;
        }

        .chat-message {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            max-width: 85%;
        }

        .user-message {
            background-color: #6366f1; /* Indigo for brukerens meldinger */
            align-self: flex-end;
            color: white;
        }

        .ai-message {
            background-color: #4a5568; /* Mellomgrå for AI-meldinger */
            align-self: flex-start;
            color: #e2e8f0;
        }

        #chatInputContainer {
            display: flex;
            gap: 0.5rem;
        }

        #chatInput {
            flex-grow: 1;
            background-color: #6b7280;
            color: #f3f4f6;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid #4b5563;
            font-size: 1rem;
        }
        #chatInput:focus {
            outline: none;
            box-shadow: 0 0 0 2px #8b5cf6; /* Added focus ring */
        }

        #chatSendButton {
            background-image: linear-gradient(to right, #059669, #10b981); /* Grønn gradient */
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            white-space: nowrap; /* Forhindrer wrapping */
        }
        #chatSendButton:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #chatSendButton:disabled {
            background-image: linear-gradient(to right, #4a5568, #667eea);
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        #loadingIndicator {
            color: #a78bfa;
            font-style: italic;
            margin-top: 0.5rem;
            text-align: center;
        }


        footer {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.875rem;
            color: #9ca3af; /* Gråere tekst */
        }

        /* Responsivitet for små skjermer */
        @media (max-width: 640px) {
            .container {
                padding: 1.5rem;
                gap: 1.5rem;
            }
            h1 {
                font-size: 2.25rem;
            }
            #guessTheNumberGame h2, #questionGame h2 {
                font-size: 1.75rem;
            }
            .game-button, .retro-game-button {
                width: 100%;
                max-width: none;
            }
            #questionGame #questionDisplay {
                font-size: 1.25rem;
            }
            #questionGame input[type="text"] {
                max-width: 100%;
            }
            #snakeCanvas, #pongCanvas {
                width: 100%;
                height: auto; /* Justeres basert på aspect ratio */
            }
            #aiChat {
                padding: 1rem;
            }
            .chat-message {
                max-width: 100%;
            }
            #chatInputContainer {
                flex-direction: column;
            }
            #chatSendButton {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Minispill for Tidsfordriv</h1>
            <p class="text-gray-300">Finn ditt favorittspill for å slappe av og ha det gøy!</p>
        </header>

        <nav class="game-menu">
            <button class="game-button" onclick="loadGame('guessTheNumber')">Gjett Tallet</button>
            <button class="game-button" onclick="loadGame('questionGame')">Spørsmålsspill</button>
            <button class="game-button" onclick="loadGame('retroGames')">Retro Spill</button>
            <button class="game-button" onclick="loadGame('aiChat')">AI Chat</button>
            <button class="game-button" onclick="loadGame('anotherGame')" disabled>Et Annet Spill (kommer)</button>
            <!-- Legg til flere spillknapper her -->
        </nav>

        <main class="game-area" id="gameArea">
            <!-- Spillinnholdet vil lastes inn her via JavaScript -->
            <p class="text-xl text-gray-400">Velg et spill fra menyen over for å begynne!</p>
        </main>

        <footer>
            <p>&copy; 2025 Minispill. Alle rettigheter reservert.</p>
        </footer>
    </div>

    <script>
        // Referanse til spillområdet
        const gameArea = document.getElementById('gameArea');

        // requestAnimationFrame ID for Pong, so it can be cancelled
        let pongAnimationFrameId = null;

        // Funksjon for å laste et spill inn i spillområdet
        function loadGame(gameName) {
            gameArea.innerHTML = ''; // Tømmer spillområdet
            // Stopp alle aktive spill-looper før et nytt spill lastes
            stopAllGameLoops();

            switch (gameName) {
                case 'guessTheNumber':
                    loadGuessTheNumberGame();
                    break;
                case 'questionGame':
                    loadQuestionGame();
                    break;
                case 'retroGames':
                    loadRetroGamesMenu();
                    break;
                case 'snakeGame': // Spesifikt for Snake, lastes fra retroGames menu
                    loadSnakeGame();
                    break;
                case 'pongGame': // Spesifikt for Pong, lastes fra retroGames menu
                    loadPongGame();
                    break;
                case 'anotherGame':
                    gameArea.innerHTML = '<h2 class="text-2xl text-yellow-400">Dette spillet kommer snart!</h2><p class="mt-2 text-gray-300">Følg med for mer moro.</p>';
                    break;
                default:
                    gameArea.innerHTML = '<p class="text-xl text-red-500">Ukjent spill.</p>';
            }
        }

        // Funksjon for å stoppe alle aktive spill-looper
        function stopAllGameLoops() {
            // Snake game loop
            if (snakeGameLoopId) {
                clearTimeout(snakeGameLoopId);
                snakeGameLoopId = null;
            }
            // Pong game loop
            if (pongAnimationFrameId) {
                cancelAnimationFrame(pongAnimationFrameId);
                pongAnimationFrameId = null;
            }
            // Legg til andre spill-looper her hvis de bruker requestAnimationFrame eller setInterval/setTimeout
            document.removeEventListener('keydown', changeDirection); // Fjern snake controls
            document.removeEventListener('keydown', handlePongKeyPress); // Fjern pong controls
            document.removeEventListener('keyup', handlePongKeyRelease); // Fjern pong controls
        }


        // --- Gjett Tallet-spillet ---
        function loadGuessTheNumberGame() {
            gameArea.innerHTML = `
                <div id="guessTheNumberGame" class="w-full max-w-md bg-gray-700 p-8 rounded-xl shadow-lg">
                    <h2 class="mb-6">Gjett Tallet!</h2>
                    <p class="text-lg mb-4">Jeg tenker på et tall mellom 1 og 100.</p>
                    <input type="number" id="guessInput" placeholder="Skriv inn ditt gjetning" min="1" max="100" class="focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button onclick="checkGuess()" class="mt-4 w-full">Gjett!</button>
                    <p id="gameMessage" class="text-gray-200 mt-4"></p>
                    <p id="attemptsCount" class="text-gray-400"></p>
                    <button onclick="resetGuessTheNumberGame()" class="mt-6 bg-red-600 hover:bg-red-700 w-full">Start Nytt Spill</button>
                </div>
            `;

            // Initialiser spillvariabler for "Gjett Tallet"
            secretNumber = generateRandomNumber(1, 100);
            attempts = 0;
            updateGuessTheNumberUI();
            console.log("Secret number (for testing):", secretNumber); // Fjern denne i et ekte spill!
        }

        let secretNumber;
        let attempts;

        function generateRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function updateGuessTheNumberUI() {
            document.getElementById('attemptsCount').textContent = `Antall forsøk: ${attempts}`;
        }

        function checkGuess() {
            const guessInput = document.getElementById('guessInput');
            const gameMessage = document.getElementById('gameMessage');
            const guess = parseInt(guessInput.value);

            if (isNaN(guess) || guess < 1 || guess > 100) {
                gameMessage.textContent = "Vennligst skriv inn et gyldig tall mellom 1 og 100.";
                gameMessage.style.color = '#f87171'; /* rød */
                return;
            }

            attempts++;
            updateGuessTheNumberUI();

            if (guess === secretNumber) {
                gameMessage.textContent = `Gratulerer! Du gjettet riktig tall (${secretNumber}) på ${attempts} forsøk!`;
                gameMessage.style.color = '#34d399'; /* grønn */
                guessInput.disabled = true; // Deaktiver input etter vinner
            } else if (guess < secretNumber) {
                gameMessage.textContent = "For lavt! Prøv et høyere tall.";
                gameMessage.style.color = '#facc15'; /* gul */
            } else {
                gameMessage.textContent = "For høyt! Prøv et lavere tall.";
                gameMessage.style.color = '#facc15'; /* gul */
            }

            guessInput.value = ''; // Tøm inputfeltet
            guessInput.focus(); // Sett fokus tilbake til inputfeltet
        }

        function resetGuessTheNumberGame() {
            secretNumber = generateRandomNumber(1, 100);
            attempts = 0;
            document.getElementById('guessInput').value = '';
            document.getElementById('guessInput').disabled = false;
            document.getElementById('gameMessage').textContent = '';
            updateGuessTheNumberUI();
            console.log("Secret number (for testing):", secretNumber); // Fjern denne i et ekte spill!
        }

        // --- Spørsmålsspillet ---
        let questions = [];
        let currentQuestionIndex;
        let correctAnswers = 0;
        let totalQuestionsAsked = 0;
        const LEADERBOARD_KEY = 'questionGameLeaderboard'; // Nøkkel for localStorage

        // Shuffle function (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
        }

        function loadQuestionGame() {
            gameArea.innerHTML = `
                <div id="questionGame" class="w-full max-w-lg bg-gray-700 p-8 rounded-xl shadow-lg flex flex-col items-center">
                    <h2 class="mb-6">Spørsmålsspill!</h2>
                    <p id="questionDisplay" class="mb-4"></p>
                    <input type="text" id="answerInput" placeholder="Skriv inn ditt svar her" class="focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    <div class="button-group flex justify-center mt-4">
                        <button onclick="checkQuestionAnswer()">Svar</button>
                        <button onclick="nextQuestion()" class="bg-gray-600 hover:bg-gray-500">Neste Spørsmål</button>
                    </div>
                    <p id="answerMessage" class="text-gray-200 mt-4"></p>
                    <p id="scoreDisplay" class="text-gray-400 mt-2">Poeng: 0 / 0</p>
                    <button onclick="resetQuestionGame()" class="mt-6 bg-red-600 hover:bg-red-700 w-full">Start Nytt Spill</button>
                </div>

                <div id="leaderboard-container" class="mt-8">
                    <h3>Resultatliste</h3>
                    <ol id="leaderboardList"></ol>
                </div>
            `;

            initializeQuestionGame();
            loadAndDisplayLeaderboard(); // Last og vis resultatliste ved oppstart
        }

        function initializeQuestionGame() {
            // Definer en stor spørsmålsbase
            const allQuestions = [
                { question: "Hva er hovedstaden i Norge?", answer: "Oslo" },
                { question: "Hvilket grunnstoff har kjemisk symbol 'O'?", answer: "Oksygen" },
                { question: "Hva heter verdens største hav?", answer: "Stillehavet" },
                { question: "Hvilken planet er kjent som 'Den røde planet'?", answer: "Mars" },
                { question: "Hvem skrev 'Peer Gynt'?", answer: "Henrik Ibsen" },
                { question: "Hvor mange dager er det i et skuddår?", answer: "366" },
                { question: "Hva er resultatet av 7 x 8?", answer: "56" },
                { question: "Hvilken fugl er et symbol for fred?", answer: "Due" },
                { question: "Hva heter den høyeste fjelltoppen i verden?", answer: "Mount Everest" },
                { question: "Hvilket dyr gir oss ull?", answer: "Sau" },
                { question: "Hva heter Norges lengste elv?", answer: "Glomma" },
                { question: "Hvilken farge får du hvis du blander blått og gult?", answer: "Grønn" },
                { question: "Hva heter det største organet i menneskekroppen?", answer: "Hud" },
                { question: "Hva heter valutaen i Japan?", answer: "Yen" },
                { question: "Hvilken sport bruker en puck?", answer: "Ishockey" },
                { question: "Hva er hovedstaden i Sverige?", answer: "Stockholm" },
                { question: "Hvilken måned har 28 dager (utenom skuddår)?", answer: "Februar" },
                { question: "Hva heter dyret som er en 'kongle-spiser'?", answer: "Eikenøtt" },
                { question: "Hva er motsatt av 'kald'?", answer: "Varm" },
                { question: "Hvilken by er kjent for Eiffeltårnet?", answer: "Paris" },
                { question: "Hva heter havnen i Bergen?", answer: "Bryggen" },
                { question: "Hvilket instrument har 88 tangenter?", answer: "Piano" },
                { question: "Hva er et annet navn for et 'sekskantet' objekt?", answer: "Heksagon" },
                { question: "Hvilken type frukt er en banan?", answer: "Bær" },
                { question: "Hva er den største ørkenen i verden?", answer: "Sahara" },
                { question: "Hvem malte 'Skrik'?", answer: "Edvard Munch" },
                { question: "Hva heter Norges nasjonalfugl?", answer: "Fossekall" },
                { question: "Hvor mange bein har en edderkopp?", answer: "8" },
                { question: "Hva er den offisielle hovedstaden i Canada?", answer: "Ottawa" },
                { question: "Hvilket hav skiller Europa og Afrika?", answer: "Middelhavet" },
                { question: "Hva heter fiktive karakteren som bor i en ananas under havet?", answer: "Svampebob Firkant" },
                { question: "Hva er det høyeste bygget i verden?", answer: "Burj Khalifa" },
                { question: "Hvilken farge er solsikker?", answer: "Gul" },
                { question: "Hva heter det første mennesket på månen?", answer: "Neil Armstrong" },
                { question: "Hvilket land er kjent for pizza og pasta?", answer: "Italia" },
                { question: "Hva er en gruppe løver kalt?", answer: "Stolthet" },
                { question: "Hvilken metall er flytende ved romtemperatur?", answer: "Kvikksølv" },
                { question: "Hva er hovedstaden i Tyskland?", answer: "Berlin" },
                { question: "Hva heter det største pattedyr i verden?", answer: "Blåhval" },
                { question: "Hva er det mest vanlige navnet i verden?", answer: "Mohammed" },
                { question: "Hva heter elven som renner gjennom London?", answer: "Themsen" },
                { question: "Hva er det minste landet i verden?", answer: "Vatikanstaten" },
                { question: "Hva heter den største øya i verden?", answer: "Grønland" },
                { question: "Hva er hovedingrediensen i guacamole?", answer: "Avocado" },
                { question: "Hvilken planet er nærmest solen?", answer: "Mercur" },
                { question: "Hva er det kjemiske symbolet for vann?", answer: "H2O" },
                { question: "Hvilken farge er himmelen på en klar dag?", answer: "Blå" },
                { question: "Hvilket dyr er kjent for å bygge demninger?", answer: "Bever" },
                { question: "Hva heter sporten der man kaster en javelin?", answer: "Spydkast" },
                { question: "Hvilken del av et tre leder vann opp til bladene?", answer: "Stamme" }
            ];

            questions = [...allQuestions]; // Lag en kopi
            shuffleArray(questions);
            currentQuestionIndex = -1; // Start før første spørsmål
            correctAnswers = 0;
            totalQuestionsAsked = 0;
            nextQuestion(); // Last inn det første spørsmålet
            updateQuestionScore();
        }

        function displayQuestion() {
            const questionDisplay = document.getElementById('questionDisplay');
            const answerInput = document.getElementById('answerInput');
            const answerMessage = document.getElementById('answerMessage');

            // Skjul eventuell input for kallenavn
            const nicknameInputContainer = document.getElementById('nicknameInputContainer');
            if (nicknameInputContainer) {
                nicknameInputContainer.remove();
            }

            if (currentQuestionIndex < questions.length) {
                questionDisplay.textContent = questions[currentQuestionIndex].question;
                answerInput.value = '';
                answerInput.disabled = false;
                answerMessage.textContent = '';
                answerInput.focus();
            } else {
                // Spill slutt
                questionDisplay.textContent = `Spillet er ferdig! Du svarte riktig på ${correctAnswers} av ${totalQuestionsAsked} spørsmål.`;
                answerInput.disabled = true;
                answerMessage.textContent = '';

                // Sjekk om poengsummen er god nok for resultatlisten
                loadAndDisplayLeaderboard(); // Last for å få siste liste
                const currentLeaderboard = getLeaderboard();
                const lowestScoreOnLeaderboard = currentLeaderboard.length < 5 ? -1 : currentLeaderboard[currentLeaderboard.length - 1].score;

                if (correctAnswers > lowestScoreOnLeaderboard) {
                    showNicknameInput();
                } else {
                    setTimeout(() => {
                        answerMessage.textContent = "Prøv igjen for å komme på resultatlisten!";
                        answerMessage.style.color = '#facc15'; // Gul
                    }, 1000);
                }
            }
        }

        function checkQuestionAnswer() {
            const answerInput = document.getElementById('answerInput');
            const answerMessage = document.getElementById('answerMessage');
            const userAnswer = answerInput.value.trim().toLowerCase();
            const correctAnswer = questions[currentQuestionIndex].answer.trim().toLowerCase();

            // Sjekk om svar allerede er gitt for dette spørsmålet
            if (answerInput.disabled) {
                return;
            }

            totalQuestionsAsked++; // Teller antall spørsmål besvart

            if (userAnswer === correctAnswer) {
                answerMessage.textContent = "Riktig svar! 🎉";
                answerMessage.style.color = '#34d399'; /* grønn */
                correctAnswers++;
            } else {
                answerMessage.textContent = `Feil svar. Svaret var: ${questions[currentQuestionIndex].answer}`;
                answerMessage.style.color = '#f87171'; /* rød */
            }
            answerInput.disabled = true; // Deaktiver input etter svar
            updateQuestionScore();
        }

        function nextQuestion() {
            const answerMessage = document.getElementById('answerMessage');
            const answerInput = document.getElementById('answerInput');

            // Hvis spørsmål ikke er svart på, tell det som feil
            if (currentQuestionIndex >= 0 && !answerInput.disabled && currentQuestionIndex < questions.length) {
                 totalQuestionsAsked++;
                 answerMessage.textContent = `Du hoppet over dette. Svaret var: ${questions[currentQuestionIndex].answer}`;
                 answerMessage.style.color = '#facc15'; /* gul */
                 updateQuestionScore();
            }

            currentQuestionIndex++;
            displayQuestion();
        }

        function updateQuestionScore() {
            document.getElementById('scoreDisplay').textContent = `Poeng: ${correctAnswers} / ${totalQuestionsAsked}`;
        }

        function resetQuestionGame() {
            initializeQuestionGame();
            document.getElementById('answerMessage').textContent = '';
        }

        // --- Resultatliste (Leaderboard) funksjoner ---
        function getLeaderboard() {
            const leaderboardJson = localStorage.getItem(LEADERBOARD_KEY);
            return leaderboardJson ? JSON.parse(leaderboardJson) : [];
        }

        function saveLeaderboard(leaderboardData) {
            localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboardData));
        }

        function addScoreToLeaderboard(nickname, score, total) {
            let leaderboard = getLeaderboard();
            leaderboard.push({ nickname: nickname, score: score, totalQuestions: total });

            // Sorter etter poeng (synkende), deretter etter totalt antall spørsmål (stigende for å bryte bånd)
            leaderboard.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return a.totalQuestions - b.totalQuestions; // Færre spørsmål for samme score vinner
            });

            // Behold kun de 5 beste
            leaderboard = leaderboard.slice(0, 5);
            saveLeaderboard(leaderboard);
            loadAndDisplayLeaderboard(); // Oppdater visningen
        }

        function loadAndDisplayLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) return; // Sjekk om elementet eksisterer

            const leaderboard = getLeaderboard();
            leaderboardList.innerHTML = ''; // Tømmer listen

            if (leaderboard.length === 0) {
                leaderboardList.innerHTML = '<li class="text-center text-gray-400">Ingen resultater ennå. Spill for å komme på listen!</li>';
                return;
            }

            leaderboard.forEach((entry, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span>${index + 1}. ${entry.nickname}</span>
                    <span class="leaderboard-score">${entry.score} / ${entry.totalQuestions}</span>
                `;
                leaderboardList.appendChild(listItem);
            });
        }

        function showNicknameInput() {
            const questionGameDiv = document.getElementById('questionGame');
            const nicknameInputContainer = document.createElement('div');
            nicknameInputContainer.id = 'nicknameInputContainer';
            nicknameInputContainer.className = 'mt-6 bg-gray-600 p-4 rounded-lg shadow-md w-full max-w-md'; // Mindre enn spillets div
            nicknameInputContainer.innerHTML = `
                <p class="text-white mb-2">Gratulerer! Skriv inn ditt kallenavn for resultatlisten:</p>
                <input type="text" id="nicknameInput" placeholder="Kallenavn" class="w-full mb-2">
                <button onclick="submitNickname()" class="w-full">Lagre Poengsum</button>
            `;
            questionGameDiv.appendChild(nicknameInputContainer);
            document.getElementById('nicknameInput').focus();
        }

        function submitNickname() {
            const nicknameInput = document.getElementById('nicknameInput');
            let nickname = nicknameInput.value.trim();

            if (nickname === "") {
                nickname = "Anonym"; // Standard kallenavn hvis tom
            }

            addScoreToLeaderboard(nickname, correctAnswers, totalQuestionsAsked);

            // Fjern kallenavninput og gi tilbakemelding
            const nicknameInputContainer = document.getElementById('nicknameInputContainer');
            if (nicknameInputContainer) {
                nicknameInputContainer.remove();
            }
            const answerMessage = document.getElementById('answerMessage');
            answerMessage.textContent = `Poengsum lagret under ${nickname}!`;
            answerMessage.style.color = '#34d399'; // Grønn
        }

        // --- Retro Games Menu ---
        function loadRetroGamesMenu() {
            gameArea.innerHTML = `
                <div class="retro-game-menu w-full max-w-2xl">
                    <h2 class="text-3xl font-bold text-blue-300 mb-6 w-full text-center">90-talls Retro Spill</h2>
                    <button class="retro-game-button" onclick="loadGame('snakeGame')">Snake</button>
                    <button class="retro-game-button" onclick="loadGame('pongGame')">Pong</button>
                    <button class="retro-game-button" disabled>Tetris Lite (kommer)</button>
                    <button class="retro-game-button" disabled>Pac-Man Lite (kommer)</button>
                    <button class="retro-game-button" disabled>Space Invaders Lite (kommer)</button>
                    <button class="retro-game-button" disabled>Brick Breaker (kommer)</button>
                    <button class="retro-game-button" disabled>Frogger Lite (kommer)</button>
                    <button class="retro-game-button" disabled>Connect Four (kommer)</button>
                    <button class="retro-game-button" disabled>Tic-Tac-Toe (kommer)</button>
                    <button class="retro-game-button" disabled>Minesweeper Lite (kommer)</button>
                    <button class="retro-game-button" disabled>Simon Says (kommer)</button>
                    <button class="retro-game-button" disabled>Whack-A-Mole (kommer)</button>
                    <button class="retro-game-button" disabled>Flappy Bird (kommer)</button>
                    <button class="retro-game-button" disabled>Crossy Road (kommer)</button>
                    <button class="retro-game-button" disabled>Endless Runner (kommer)</button>
                    <button class="retro-game-button" disabled>Pinball Lite (kommer)</button>
                    <button class="retro-game-button" disabled>Hangman (kommer)</button>
                    <button class="retro-game-button" disabled>Guess the Word (kommer)</button>
                    <button class="retro-game-button" disabled>Rock-Paper-Scissors (kommer)</button>
                    <button class="retro-game-button" disabled>Memory Game (kommer)</button>
                    <button class="retro-game-button" disabled>Sudoku (kommer)</button>
                    <button class="retro-game-button" disabled>Battleship Lite (kommer)</button>
                    <button class="retro-game-button" disabled>Mastermind (kommer)</button>
                    <button class="retro-game-button" disabled>2048 (kommer)</button>
                    <button class="retro-game-button" disabled>Doodle Jump (kommer)</button>
                </div>
            `;
        }

        // --- Snake Game ---
        let snakeCanvas, snakeCtx;
        const GRID_SIZE = 20; // Størrelse på hver rute i rutenettet
        let snake = [{ x: 10, y: 10 }];
        let food = {};
        let dx = 0; // x hastighet
        let dy = 0; // y hastighet
        let score = 0;
        let changingDirection = false;
        let snakeGameLoopId = null; // Lagrer setTimeout ID for pausing/resetting

        function loadSnakeGame() {
            gameArea.innerHTML = `
                <div id="snakeGame" class="w-full max-w-lg bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col items-center">
                    <h2 class="text-2xl font-bold text-blue-400 mb-4">Snake</h2>
                    <canvas id="snakeCanvas" width="400" height="400"></canvas>
                    <div id="snakeGameControls" class="mt-4">
                        <button onclick="startGame()">Start Spill</button>
                        <button onclick="pauseGame()">Pause/Fortsett</button>
                        <button onclick="resetSnakeGame()">Nytt Spill</button>
                    </div>
                    <p id="snakeScore" class="mt-4">Poeng: 0</p>
                </div>
            `;
            snakeCanvas = document.getElementById('snakeCanvas');
            snakeCtx = snakeCanvas.getContext('2d');
            resetSnakeGame(); // Initialiser spilltilstand
            document.addEventListener('keydown', changeDirection); // Lytt etter piltaster
        }

        function createFood() {
            food = {
                x: Math.floor(Math.random() * (snakeCanvas.width / GRID_SIZE)),
                y: Math.floor(Math.random() * (snakeCanvas.height / GRID_SIZE))
            };
            // Sørg for at mat ikke dukker opp på slangen
            snake.forEach(part => {
                if (part.x === food.x && part.y === food.y) {
                    createFood(); // Rekursivt hvis mat er på slangen
                }
            });
        }

        function drawSnakePart(snakePart) {
            snakeCtx.fillStyle = '#34d399'; /* Lys grønn */
            snakeCtx.strokeStyle = '#10b981'; /* Mørkere grønn */
            snakeCtx.fillRect(snakePart.x * GRID_SIZE, snakePart.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
            snakeCtx.strokeRect(snakePart.x * GRID_SIZE, snakePart.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
        }

        function drawFood() {
            snakeCtx.fillStyle = '#f87171'; /* Rød */
            snakeCtx.strokeStyle = '#ef4444'; /* Mørkere rød */
            snakeCtx.fillRect(food.x * GRID_SIZE, food.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
            snakeCtx.strokeRect(food.x * GRID_SIZE, food.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
        }

        function draw() {
            snakeCtx.clearRect(0, 0, snakeCanvas.width, snakeCanvas.height);
            drawFood();
            snake.forEach(drawSnakePart);
        }

        function advanceSnake() {
            if (snakeGameLoopId === null && (dx === 0 && dy === 0)) return; // Spill pauset/ikke startet

            const head = { x: snake[0].x + dx, y: snake[0].y + dy };

            // Sjekk for kollisjon med vegger eller seg selv
            if (
                head.x < 0 || head.x * GRID_SIZE >= snakeCanvas.width ||
                head.y < 0 || head.y * GRID_SIZE >= snakeCanvas.height ||
                checkCollision(head)
            ) {
                gameOver("Game Over! Ditt poeng: " + score);
                return;
            }

            snake.unshift(head); // Legg til nytt hode

            const didEatFood = head.x === food.x && head.y === food.y;
            if (didEatFood) {
                score += 10;
                document.getElementById('snakeScore').textContent = `Poeng: ${score}`;
                createFood(); // Lag ny mat
            } else {
                snake.pop(); // Fjern hale hvis ingen mat spist
            }
            changingDirection = false;
        }

        function checkCollision(head) {
            // Sjekk om slangens hode kolliderer med noen del av kroppen
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) return true;
            }
            return false;
        }

        function changeDirection(event) {
            const LEFT_KEY = 37;
            const RIGHT_KEY = 39;
            const UP_KEY = 38;
            const DOWN_KEY = 40;

            if (changingDirection) return; // Forhindre raske, flere tastetrykk
            changingDirection = true;

            const keyPressed = event.keyCode;
            const goingUp = dy === -1;
            const goingDown = dy === 1;
            const goingLeft = dx === -1;
            const goingRight = dx === 1;

            if (keyPressed === LEFT_KEY && !goingRight) {
                dx = -1;
                dy = 0;
            }
            if (keyPressed === UP_KEY && !goingDown) {
                dx = 0;
                dy = -1;
            }
            if (keyPressed === RIGHT_KEY && !goingLeft) {
                dx = 1;
                dy = 0;
            }
            if (keyPressed === DOWN_KEY && !goingUp) {
                dx = 0;
                dy = 1;
            }
        }

        function gameLoop() {
            snakeGameLoopId = setTimeout(function onTick() {
                advanceSnake();
                draw();
                gameLoop(); // Kall seg selv rekursivt
            }, 100); // Spillhastighet (lavere er raskere)
        }

        function startGame() {
            if (snakeGameLoopId === null) { // Start kun hvis ikke allerede kjører
                if (dx === 0 && dy === 0) { // Hvis spillet nettopp ble tilbakestilt eller aldri startet, gi en startretning
                     dx = 1; // Start bevegelse til høyre
                }
                gameLoop();
            }
        }

        function pauseGame() {
            if (snakeGameLoopId) {
                clearTimeout(snakeGameLoopId);
                snakeGameLoopId = null;
            } else {
                startGame(); // Fortsett
            }
        }

        function resetSnakeGame() {
            clearTimeout(snakeGameLoopId); // Stopp nåværende spill-loop
            snakeGameLoopId = null;
            snake = [{ x: 10, y: 10 }]; // Tilbakestill slangens posisjon
            dx = 0; // Tilbakestill retning
            dy = 0;
            score = 0;
            document.getElementById('snakeScore').textContent = `Poeng: ${score}`;
            createFood(); // Plasser ny mat
            draw(); // Første tegning
        }

        function gameOver(message) {
            clearTimeout(snakeGameLoopId);
            snakeGameLoopId = null;
            // Erstatt alert med en melding i UI
            document.getElementById('snakeScore').textContent = message;
            // resetSnakeGame(); // Tilbakestill spillet automatisk etter melding
        }

        // --- Pong Game ---
        let pongCanvas, pongCtx;
        let paddle1, paddle2, ball;
        let player1Score, player2Score;
        let pongGameLoopId = null; // For requestAnimationFrame
        let pongMessageElement;
        let pongScoreElement;

        // Kontrollflagg for å håndtere vedvarende tastetrykk
        const keysPressed = {};

        function loadPongGame() {
            gameArea.innerHTML = `
                <div id="pongGame" class="w-full max-w-lg bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col items-center">
                    <h2 class="text-2xl font-bold text-red-400 mb-4">Pong</h2>
                    <canvas id="pongCanvas" width="500" height="300" class="border-2 border-red-500 rounded-lg"></canvas>
                    <div id="pongGameControls" class="mt-4 flex gap-4">
                        <button onclick="startGamePong()">Start Spill</button>
                        <button onclick="resetPongGame()">Nytt Spill</button>
                    </div>
                    <p id="pongScore" class="mt-4 text-xl font-bold text-red-300">Poeng: Spiller 1: 0 - Spiller 2: 0</p>
                    <p id="pongMessage" class="mt-2 text-lg text-yellow-300"></p>
                    <div class="pong-controls-info">
                        <p>Kontroller:</p>
                        <p>Spiller 1 (venstre): W (opp), S (ned)</p>
                        <p>Spiller 2 (høyre): Pil opp, Pil ned</p>
                    </div>
                </div>
            `;
            pongCanvas = document.getElementById('pongCanvas');
            pongCtx = pongCanvas.getContext('2d');
            pongMessageElement = document.getElementById('pongMessage');
            pongScoreElement = document.getElementById('pongScore');

            // Legg til tastaturlyttere
            document.addEventListener('keydown', handlePongKeyPress);
            document.addEventListener('keyup', handlePongKeyRelease);

            resetPongGame();
        }

        function initPongObjects() {
            // Paddle setup
            paddle1 = { x: 10, y: pongCanvas.height / 2 - 30, width: 10, height: 60, dy: 0, color: '#06b6d4' };
            paddle2 = { x: pongCanvas.width - 20, y: pongCanvas.height / 2 - 30, width: 10, height: 60, dy: 0, color: '#f87171' };

            // Ball setup
            ball = { x: pongCanvas.width / 2, y: pongCanvas.height / 2, radius: 7, dx: 0, dy: 0, color: '#e0e7ff' };
        }

        function resetPongGame() {
            if (pongAnimationFrameId) {
                cancelAnimationFrame(pongAnimationFrameId);
            }
            pongAnimationFrameId = null;

            player1Score = 0;
            player2Score = 0;
            updatePongScore();
            pongMessageElement.textContent = "Trykk 'Start Spill' for å begynne!";
            initPongObjects(); // Tilbakestill posisjoner
            drawPong();
        }

        function serveBall() {
            ball.x = pongCanvas.width / 2;
            ball.y = pongCanvas.height / 2;
            ball.dx = (Math.random() > 0.5 ? 3 : -3) * (Math.random() > 0.5 ? 1 : 1); // Start med tilfeldig retning
            ball.dy = (Math.random() * 2 - 1) * 2; // Litt tilfeldig vertikal retning
        }

        function drawPong() {
            // Bakgrunn
            pongCtx.fillStyle = 'black';
            pongCtx.fillRect(0, 0, pongCanvas.width, pongCanvas.height);

            // Midtlinje
            pongCtx.strokeStyle = '#6b7280';
            pongCtx.beginPath();
            pongCtx.setLineDash([5, 5]);
            pongCtx.moveTo(pongCanvas.width / 2, 0);
            pongCtx.lineTo(pongCanvas.width / 2, pongCanvas.height);
            pongCtx.stroke();
            pongCtx.setLineDash([]); // Tilbakestill

            // Paddles
            pongCtx.fillStyle = paddle1.color;
            pongCtx.fillRect(paddle1.x, paddle1.y, paddle1.width, paddle1.height);
            pongCtx.fillStyle = paddle2.color;
            pongCtx.fillRect(paddle2.x, paddle2.y, paddle2.width, paddle2.height);

            // Ball
            pongCtx.beginPath();
            pongCtx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            pongCtx.fillStyle = ball.color;
            pongCtx.fill();
        }

        function updatePong() {
            // Flytt paddles
            paddle1.y += paddle1.dy;
            paddle2.y += paddle2.dy;

            // Hold paddles innenfor grenser
            if (paddle1.y < 0) paddle1.y = 0;
            if (paddle1.y + paddle1.height > pongCanvas.height) paddle1.y = pongCanvas.height - paddle1.height;
            if (paddle2.y < 0) paddle2.y = 0;
            if (paddle2.y + paddle2.height > pongCanvas.height) paddle2.y = pongCanvas.height - paddle2.height;

            // Flytt ball
            ball.x += ball.dx;
            ball.y += ball.dy;

            // Ball kollisjon med topp/bunn vegger
            if (ball.y - ball.radius < 0 || ball.y + ball.radius > pongCanvas.height) {
                ball.dy = -ball.dy;
            }

            // Ball kollisjon med paddles
            // Spiller 1 (venstre)
            if (ball.dx < 0 &&
                ball.x - ball.radius < paddle1.x + paddle1.width &&
                ball.y > paddle1.y &&
                ball.y < paddle1.y + paddle1.height) {
                ball.dx = -ball.dx; // Reverser x-retning
                // Juster y-retning basert på hvor på paddle den traff
                let collidePoint = ball.y - (paddle1.y + paddle1.height / 2);
                collidePoint = collidePoint / (paddle1.height / 2); // Normaliser til -1 til 1
                ball.dy = collidePoint * 5; // Hastighet
            }
            // Spiller 2 (høyre)
            else if (ball.dx > 0 &&
                     ball.x + ball.radius > paddle2.x &&
                     ball.y > paddle2.y &&
                     ball.y < paddle2.y + paddle2.height) {
                ball.dx = -ball.dx; // Reverser x-retning
                let collidePoint = ball.y - (paddle2.y + paddle2.height / 2);
                collidePoint = collidePoint / (paddle2.height / 2);
                ball.dy = collidePoint * 5;
            }

            // Ball utenfor banen (poeng)
            if (ball.x - ball.radius < 0) {
                player2Score++;
                updatePongScore();
                if (player2Score >= 5) {
                    gameOverPong("Spiller 2 vant! 🏆");
                } else {
                    serveBall(); // Ny serve
                }
            } else if (ball.x + ball.radius > pongCanvas.width) {
                player1Score++;
                updatePongScore();
                if (player1Score >= 5) {
                    gameOverPong("Spiller 1 vant! 🏆");
                } else {
                    serveBall(); // Ny serve
                }
            }
        }

        function updatePongScore() {
            pongScoreElement.textContent = `Poeng: Spiller 1: ${player1Score} - Spiller 2: ${player2Score}`;
        }

        function gameOverPong(message) {
            if (pongAnimationFrameId) {
                cancelAnimationFrame(pongAnimationFrameId);
                pongAnimationFrameId = null;
            }
            pongMessageElement.textContent = message;
        }

        function pongGameLoop() {
            updatePong();
            drawPong();
            pongAnimationFrameId = requestAnimationFrame(pongGameLoop);
        }

        function startGamePong() {
            if (pongAnimationFrameId) { // If already running, do nothing
                return;
            }
            pongMessageElement.textContent = "";
            serveBall(); // Start med å serve ballen
            pongGameLoop();
        }

        function handlePongKeyPress(event) {
            keysPressed[event.key] = true;
            if (pongAnimationFrameId === null) return; // Ikke beveg paddles hvis spillet ikke kjører

            // Player 1 controls (W, S)
            if (keysPressed['w'] || keysPressed['W']) {
                paddle1.dy = -5;
            } else if (keysPressed['s'] || keysPressed['S']) {
                paddle1.dy = 5;
            }

            // Player 2 controls (ArrowUp, ArrowDown)
            if (keysPressed['ArrowUp']) {
                paddle2.dy = -5;
            } else if (keysPressed['ArrowDown']) {
                paddle2.dy = 5;
            }
        }

        function handlePongKeyRelease(event) {
            keysPressed[event.key] = false;

            // Player 1
            if (!(keysPressed['w'] || keysPressed['W'] || keysPressed['s'] || keysPressed['S'])) {
                paddle1.dy = 0;
            } else if (keysPressed['w'] || keysPressed['W']) { // If 'w' or 'W' is still pressed after 's' is released
                paddle1.dy = -5;
            } else if (keysPressed['s'] || keysPressed['S']) { // If 's' or 'S' is still pressed after 'w' is released
                paddle1.dy = 5;
            }

            // Player 2
            if (!(keysPressed['ArrowUp'] || keysPressed['ArrowDown'])) {
                paddle2.dy = 0;
            } else if (keysPressed['ArrowUp']) { // If 'ArrowUp' is still pressed after 'ArrowDown' is released
                paddle2.dy = -5;
            } else if (keysPressed['ArrowDown']) { // If 'ArrowDown' is still pressed after 'ArrowUp' is released
                paddle2.dy = 5;
            }
        }

        // --- AI Chat ---
        let chatHistory = []; // Stores the chat history for AI model context
        const AI_CHAT_HISTORY_KEY = 'aiChatHistory'; // Key for localStorage

        // Tool definition for Google Search (This is passed to the Gemini model)
        const tools = [
            {
                functionDeclarations: [
                    {
                        name: "google_search_search",
                        description: "Søk på Google etter informasjon. Bruk dette verktøyet når brukeren spør om fakta, definisjoner, nyheter, eller generell kunnskap som krever oppdatert informasjon eller bredere kontekst enn AI-ens standard treningsdata.",
                        parameters: {
                            type: "OBJECT",
                            properties: {
                                queries: {
                                    type: "ARRAY",
                                    items: {
                                        type: "STRING"
                                    },
                                    description: "Liste over søkestrenger. Minimum 1 søkestreng. Maks 3 søkestrenger.",
                                    minItems: 1,
                                    maxItems: 3
                                }
                            },
                            required: ["queries"]
                        }
                    }
                ]
            }
        ];

        function loadAIChat() {
            gameArea.innerHTML = `
                <div id="aiChat" class="w-full max-w-xl bg-gray-700 p-6 rounded-xl shadow-lg flex flex-col">
                    <h2 class="text-2xl font-bold text-purple-400 mb-4 text-center">AI Chat</h2>
                    <div id="chatOutput" class="flex-grow overflow-y-auto mb-4">
                        <!-- Chat messages will appear here -->
                    </div>
                    <p id="loadingIndicator" class="text-center italic text-purple-300 hidden">AI tenker...</p>
                    <div id="chatInputContainer" class="flex gap-2">
                        <input type="text" id="chatInput" placeholder="Skriv din melding her..." class="flex-grow">
                        <button id="chatSendButton" onclick="sendMessage()">Send</button>
                    </div>
                    <button onclick="resetAIChat()" class="mt-4 bg-red-600 hover:bg-red-700 w-full rounded-md py-2 px-4 text-white font-semibold">Start Ny Samtale</button>
                </div>
            `;
            // Add event listener for Enter key
            document.getElementById('chatInput').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });

            loadAIChatHistory(); // Load chat history from localStorage
            if (chatHistory.length === 0) {
                // Initial system instruction/persona for the AI
                chatHistory.push({ role: "user", parts: [{ text: "Du er en vennlig og hjelpsom AI-assistent for en minispillside. Du skal gi korte, relevante svar på spørsmål og oppmuntre brukeren til å spille spillene på siden." }] });
                displayAIChatMessage("Hei! Jeg er din AI-assistent. Hva kan jeg hjelpe deg med i dag?", 'ai-message');
            } else {
                // Re-display existing chat history
                chatHistory.forEach(msg => {
                    if (msg.role === "user") {
                        displayAIChatMessage(msg.parts[0].text, 'user-message');
                    } else if (msg.role === "model") {
                        // Skip system/tool responses in display, just show actual AI text
                        if (msg.parts[0].text) {
                            displayAIChatMessage(msg.parts[0].text, 'ai-message');
                        }
                    } else if (msg.role === "tool") {
                        // Optionally display tool output for debugging/transparency, but usually hidden
                        // displayAIChatMessage("AI brukte et verktøy og fikk svar.", 'ai-message');
                    }
                });
            }
        }

        function displayAIChatMessage(message, type) {
            const chatOutput = document.getElementById('chatOutput');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            messageDiv.textContent = message;
            chatOutput.appendChild(messageDiv);
            chatOutput.scrollTop = chatOutput.scrollHeight; // Scroll to bottom
        }

        function loadAIChatHistory() {
            const historyJson = localStorage.getItem(AI_CHAT_HISTORY_KEY);
            if (historyJson) {
                chatHistory = JSON.parse(historyJson);
                // Ensure initial persona message is handled correctly if it was only thing in history
                if (chatHistory.length > 0 && chatHistory[0].role === "user" && chatHistory[0].parts[0].text.includes("Du er en vennlig og hjelpsom AI-assistent")) {
                    // If the first message is the persona, keep it, otherwise ensure it's not duplicated.
                    // This logic simplifies if the history is always clean at start of load.
                    // For now, let's assume if history is loaded, persona is handled.
                }
            } else {
                chatHistory = [];
            }
        }

        function saveAIChatHistory() {
            localStorage.setItem(AI_CHAT_HISTORY_KEY, JSON.stringify(chatHistory));
        }

        function resetAIChat() {
            localStorage.removeItem(AI_CHAT_HISTORY_KEY); // Clear history from local storage
            chatHistory = []; // Reset in memory as well
            loadAIChat(); // Reload chat interface, which will re-initialize history with persona
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const userMessage = chatInput.value.trim();

            if (userMessage === '') return;

            displayAIChatMessage(userMessage, 'user-message');
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            saveAIChatHistory();

            chatInput.value = '';
            chatSendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            try {
                // First call to potentially get tool calls
                const payload1 = { contents: chatHistory, tools: tools };
                const apiKey = ""; // Canvas handles API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response1 = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload1)
                });

                const result1 = await response1.json();

                if (result1.candidates && result1.candidates.length > 0) {
                    const candidate = result1.candidates[0];

                    if (candidate.toolCalls && candidate.toolCalls.length > 0) {
                        // AI wants to use a tool (e.g., google_search)
                        const toolCall = candidate.toolCalls[0]; // Assuming one tool call for simplicity
                        
                        if (toolCall.functionCall.name === "google_search_search") {
                            // Execute google_search tool
                            const queries = toolCall.functionCall.args.queries;
                            loadingIndicator.textContent = "AI søker på Google..."; // Update loading message
                            
                            // Simulate tool execution (replace with actual API call if not in Canvas)
                            const toolResponse = await googleSearch(queries); // This will call the helper function below

                            // Add tool response to history
                            chatHistory.push({
                                role: "tool",
                                parts: [{
                                    functionResponse: {
                                        name: "google_search_search",
                                        response: toolResponse
                                    }
                                }]
                            });
                            saveAIChatHistory();

                            // Make second call with tool response in history
                            loadingIndicator.textContent = "AI tenker på svaret..."; // Update loading message
                            const payload2 = { contents: chatHistory, tools: tools }; // Include tools again
                            const response2 = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload2)
                            });
                            const result2 = await response2.json();

                            if (result2.candidates && result2.candidates.length > 0 &&
                                result2.candidates[0].content && result2.candidates[0].content.parts &&
                                result2.candidates[0].content.parts.length > 0) {
                                const aiResponse = result2.candidates[0].content.parts[0].text;
                                displayAIChatMessage(aiResponse, 'ai-message');
                                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                                saveAIChatHistory();
                            } else {
                                displayAIChatMessage("Beklager, jeg fikk ikke et svar etter søk. Prøv igjen.", 'ai-message');
                                console.error("Uventet AI-responsstruktur etter søk:", result2);
                            }

                        } else {
                            displayAIChatMessage("AI forsøkte å bruke et ukjent verktøy.", 'ai-message');
                            console.error("Ukjent verktøy kalt:", toolCall.functionCall.name);
                        }

                    } else if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
                        // AI responds directly without a tool
                        const aiResponse = candidate.content.parts[0].text;
                        displayAIChatMessage(aiResponse, 'ai-message');
                        chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                        saveAIChatHistory();
                    } else {
                        displayAIChatMessage("Beklager, jeg fikk et tomt svar fra AI. Prøv igjen.", 'ai-message');
                        console.error("Tomt AI-svar:", result1);
                    }
                } else {
                    displayAIChatMessage("Beklager, jeg fikk ingen kandidater fra AI. Prøv igjen.", 'ai-message');
                    console.error("Ingen AI-kandidater:", result1);
                }

            } catch (error) {
                console.error("Feil ved henting av AI-svar:", error);
                displayAIChatMessage("En feil oppstod. Klarte ikke å hente svar fra AI.", 'ai-message');
            } finally {
                chatSendButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                loadingIndicator.textContent = "AI tenker..."; // Reset loading message
                chatInput.focus();
            }
        }

        // Helper function to simulate google_search tool call
        // In a real Canvas environment, this would be handled by the backend directly
        // but here we simulate the client-side API call for the purpose of the immersive.
        async function googleSearch(queries) {
            const searchResults = [];
            for (const query of queries) {
                // In a real application, you would make a fetch call to a backend
                // that then calls the Google Search API (e.g., Custom Search API, SerpApi, etc.)
                // Directly calling Google Search API from client-side is not recommended due to API key exposure
                // For this Canvas environment, we are simulating the Google Search API call.
                // The actual `google_search.search` call is handled by the Canvas runtime.
                // Here, we're just formatting the expected output structure for the model.

                // Example of a simulated search result for demonstration:
                // This part will be replaced by the actual tool execution in the Canvas environment.
                // For the purpose of this example, we need to return a structure that the model expects.

                let dummyResults = {
                    query: query,
                    results: [
                        { snippet: `Søkeresultat for '${query}': Her er et generelt svar fra en simuliert søk om ${query}. Dette er kun for å demonstrere at verktøyet ble brukt.` },
                        { snippet: `Mer informasjon: En typisk søkemotor ville funnet relevanter lenker og utdrag om ${query}.` }
                    ]
                };

                // The actual call if this were a backend service
                // const searchResponse = await fetch('YOUR_BACKEND_SEARCH_ENDPOINT', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ query: query })
                // });
                // const searchData = await searchResponse.json();
                // searchResults.push(searchData);

                // For Canvas context, the model expects a direct `functionResponse` with the structured data.
                // We'll just return the simulated data here, as the model's call will trigger the actual tool.
                searchResults.push(dummyResults);
            }
            // Return the structured output that the model expects from a tool
            // For `google_search`, it returns a list of SearchResults objects.
            return searchResults;
        }


        // Laster "Gjett Tallet"-spillet automatisk når siden lastes som standard
        window.onload = () => loadGame('guessTheNumber');

    </script>
</body>
</html>
